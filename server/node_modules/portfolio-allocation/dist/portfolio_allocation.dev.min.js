/*! portfolio-allocation - v0.0.10 (2020-09-14), Roman Rubsamen <roman.rubsamen@gmail.com> */
var PortfolioAllocation=PortfolioAllocation||{};PortfolioAllocation=function(y){function z(t){var r={getCorrelationMatrix:function(t){for(var r=k(this.nbRows,this.nbColumns,t),n=0;n<r.nbRows;++n){for(var o=Math.sqrt(this.data[n*this.nbColumns+n]),i=0;i<n;++i)r.data[n*r.nbColumns+i]=r.data[i*this.nbColumns+n];for(i=n+(r.data[n*r.nbColumns+i]=1);i<r.nbColumns;++i){var e=Math.sqrt(this.data[i*this.nbColumns+i]);r.data[n*r.nbColumns+i]=this.data[n*this.nbColumns+i]/(o*e)}}return r},getVariances:function(t){return this.diagonal(t)},getStandardDeviations:function(t){return this.diagonal(t).elemMap(function(t,r,n){return Math.sqrt(n)},t)},standardizedGeneralizedVariance:function(){var t=this.determinant();if(t<0)throw new Error("covariance matrix is not positive semi-definite");return Math.pow(t,1/this.nbRows)}};for(var n in r)t[n]=r[n]}function it(t){function o(t){var r=Object.prototype.toString.call(t);return"[object Array]"===r||"[object Int8Array]"===r||"[object Uint8Array]"===r||"[object Uint8ClampedArray]"===r||"[object Int16Array]"===r||"[object Uint16Array]"===r||"[object Int32Array]"===r||"[object Uint32Array]"===r||"[object Float32Array]"===r||"[object Float64Array]"===r}if(!(this instanceof it))return new it(t);var i=this;if(o(t)&&o(t[0]))return function(t){i=k(t.length,t[0].length);for(var r=0;r<i.nbRows;++r){if(!o(t[r]))throw new Error("unsupported input type");if(t[r].length!==i.nbColumns)throw new Error("unsupported input type");for(var n=0;n<i.nbColumns;++n)i.data[r*i.nbColumns+n]=t[r][n]}return i}(t);if(o(t))return function(t){i=k(t.length,1);for(var r=0;r<i.nbRows;++r)i.data[r*i.nbColumns]=t[r];return i}(t);if(t instanceof it)return function(t){i=k(t.nbRows,t.nbColumns);for(var r=t.nbRows*t.nbColumns,n=0;n<r;++n)i.data[n]=t.data[n];return i}(t);throw new Error("unsupported input type")}function k(t,r,n){var o;if(void 0===n)(o=Object.create(it.prototype)).nbRows=t,o.nbColumns=r,o.data="function"==typeof Float64Array?new Float64Array(o.nbRows*o.nbColumns):new Array(o.nbRows*o.nbColumns);else{if(!(n instanceof it))throw new Error("provided output must be a matrix");if(n.nbRows!==t||n.nbColumns!==r)throw new Error("provided output matrix size does not match expected matrix size: ("+n.nbRows+","+n.nbColumns+") v.s. ("+t+","+r+")");o=n}return o}function nt(t){if(!(this instanceof nt))return new nt;this.WORD_LENGTH=32,this.WORD_LOG=5,this.words="function"==typeof Uint32Array?new Uint32Array(0):new Array(0);var n=this;(t instanceof Array||"function"==typeof Uint32Array&&t instanceof Uint32Array)&&function(t){for(var r=0;r<t.length;++r)n.set(t[r])}(t),this.iterator=function(){for(this.w_idx=-1,this.w=0;this.w_idx<n.words.length&&0==this.w;)++this.w_idx,this.w=n.words[this.w_idx];this.next=function(){if(this.w_idx==n.words.length)return 0;var t=this.w&-this.w,r=(this.w_idx<<n.WORD_LOG)+nt.populationCount(t-1|0);for(this.w^=t;this.w_idx<n.words.length&&0==this.w;)++this.w_idx,this.w=n.words[this.w_idx];return r}}}function N(t){this.prob="function"==typeof Float64Array?new Float64Array(t.length):new Array(t.length),this.alias="function"==typeof Uint32Array?new Uint32Array(t.length):new Array(t.length);for(var r=1/t.length,n="function"==typeof Uint32Array?new Uint32Array(t.length):new Array(t.length),o=0,i="function"==typeof Uint32Array?new Uint32Array(t.length):new Array(t.length),e=0,a=0;a<t.length;++a)t[a]>r?(i[e]=a,++e):(n[o]=a,++o);for(t=t.slice(0);0<o&&0<e;){a=n[--o];var s=i[--e];this.prob[a]=t.length*t[a],t[this.alias[a]=s]=t[s]+(t[a]-r),t[s]>r?(i[e]=s,++e):(n[o]=s,++o)}for(;0<o;)--o,this.prob[n[o]]=1;for(;0<e;)--e,this.prob[i[e]]=1;this.sample=function(){var t=Math.random()*this.prob.length,r=Math.floor(t);return t-r<=this.prob[r]?r:this.alias[r]}}function o(t,r,n){this.n=t,this.k=r,this.reuseOutputArray=n,this.firstcall=!0,this.mtc=!1,this.r="function"==typeof Uint32Array?new Uint32Array(r):new Array(r),this.t=this.n,this.h=0,this.next=function(){if(!this.firstcall&&!this.mtc)return-1;if(this.firstcall){this.firstcall=!1,this.r[0]=this.n;for(var t=1;t<=this.k-1;++t)this.r[t]=0}else 1<this.t&&(this.h=0),++this.h,this.t=this.r[this.h-1],this.r[this.h-1]=0,this.r[0]=this.t-1,++this.r[this.h];return this.mtc=this.r[this.k-1]!=this.n,this.reuseOutputArray?this.r:this.r.slice(0)}}function U(t,r,n){if(void 0===r){this.r="function"==typeof Uint32Array?new Uint32Array(t):new Array(t);for(var o=0;o<t;++o)this.r[o]=o+1}else this.r=r;function i(){for(var t=Math.random();0===t;)t=Math.random();return t}this.rrlen=this.r.length,this.reuseOutputArray=n,this.next=function(){if(this.reuseOutputArray)var t=this.r;else t=this.r.slice(0);for(var r=1;r<=this.rrlen;++r){var n=r+Math.floor(i()*(this.rrlen+1-r)),o=t[n-1];t[n-1]=t[r-1],t[r-1]=o}return t}}function R(t,r,n){this.n=t,this.k=r,this.useArrayCopy=n,this.a="function"==typeof Uint32Array?new Uint32Array(r):new Array(r),this.firstcall=!0,this.mtc=!1,this.m2=0,this.h=this.k,this.endval=this.n-this.k+1,this.next=function(){if(!(this.firstcall||this.mtc&&0!==this.k))return-1;this.firstcall?this.firstcall=!1:(this.m2<this.n-this.h&&(this.h=0),++this.h,this.m2=this.a[this.k-this.h]);for(var t=1;t<=this.h;++t)this.a[this.k+t-this.h-1]=this.m2+t;return this.mtc=this.a[0]!=this.endval,this.useArrayCopy?this.a.slice(0):this.a}}function x(t,r,n){function d(){for(var t=Math.random();0===t;)t=Math.random();return t}this.n=t,this.k=r,this.useArrayCopy=n,this.a="function"==typeof Uint32Array?new Uint32Array(r):new Array(r),this.N,this.nn,this.idx_a,this.selected_record,this.method_a=function(){for(var t=this.N-this.nn;2<=this.nn;){for(var r=d(),n=0,o=t/this.N;r<o;)++n,--t,--this.N,o=o*t/this.N;this.selected_record+=n+1,this.a[this.idx_a++]=this.selected_record,--this.N,--this.nn}(n=Math.floor(this.N*d()))===this.N&&(n=this.N-1),this.selected_record+=n+1,this.a[this.idx_a++]=this.selected_record},this.method_d=function(){for(var t=1/this.nn,r=Math.pow(d(),t),n=1-this.nn+this.N,o=13*this.nn;1<this.nn&&o<this.N;){for(var i,e,a=1/(-1+this.nn);;){for(;i=this.N*(1-r),!((e=Math.floor(i))<n);)r=Math.pow(d(),t);var s=d(),u=Math.pow(s*this.N/n,a);if((r=u*(-i/this.N+1)*(n/(-e+n)))<=1)break;var l,h,f=1,m=-1+this.N;h=-1+this.nn>e?(l=-this.nn+this.N,-e+this.N):(l=-1-e+this.N,n);for(var c=-1+this.N;h<=c;--c)f=f*m/l,--m,--l;if(this.N/(-i+this.N)>=u*Math.pow(f,a)){r=Math.pow(d(),a);break}r=Math.pow(d(),t)}this.selected_record+=e+1,this.a[this.idx_a++]=this.selected_record,this.N=-e+(-1+this.N),--this.nn,t=a,n=-e+n,o+=-13}1<this.nn?this.method_a():((e=Math.floor(this.N*r))===this.N&&(e=this.N-1),this.selected_record+=e+1,this.a[this.idx_a++]=this.selected_record)},this.next=function(){for(var t=0;t<this.k;++t)this.a[t]=0;return this.N=this.n,this.nn=this.k,this.idx_a=0,this.selected_record=0,this.method_d(),this.useArrayCopy?this.a.slice(0):this.a}}function g(t){this.n=t,this.firstcall=!0,this.mtc=!1,this.iin="function"==typeof Uint32Array?new Uint32Array(t):new Array(t),this.ncard=0,this.next=function(){var t=[];if(!this.firstcall&&!this.mtc)return-1;if(this.firstcall){this.firstcall=!1;for(var r=0;r<=this.n-1;++r)this.iin[r]=0;this.mtc=!0}else{var n=0;if(this.ncard%2!=0)for(++n;0==this.iin[n-1];)++n;this.iin[n]=1-this.iin[n],this.ncard=this.ncard+2*this.iin[n]-1,t="function"==typeof Uint32Array?new Uint32Array(this.ncard):new Array(this.ncard);var o=0;for(r=0;r<=this.n-1;++r)1==this.iin[r]&&(t[o++]=r+1);this.mtc=this.ncard!=this.iin[this.n-1]}return t}}function C(t,r){if(t<0)throw new Error("n must be a positive integer");if(r<0)throw new Error("k must be a positive integer");if(t<r)throw new Error("k must be less than or equal to n");for(var n=1,o=1;o<=r;++o)n*=t+1-o,n/=o;return n}function E(t){for(var r=t.length,n=t[0].nbRows,o=it.zeros(n,1),i=1;i<=n;++i){for(var e=0,a=0;a<r;++a)e+=t[a].getValue(i,1);var s=e/r,u=0;for(a=0;a<r;++a)u+=t[a].getValue(i,1)-s;o.setValue(i,1,(e+u)/r)}return o}function A(e){function t(t){for(var r=0,n=0;n<a;++n){r+=f(it.xmy(t,e[n],u).vectorNorm("two"),l)}return r}function r(t){for(var r=it.zeros(s,1),n=0;n<a;++n){var o=it.xmy(t,e[n],u),i=o.vectorNorm("two");r=it.axpby(1,r,1/f(i,l),o,r)}return r}function n(t){return 0}function o(t,r){return t}var a=e.length,s=e[0].nbRows,u=it.zeros(s,1),i=E(e),l=1/a,h=B(t,r,n,o,i,{eps:1e-4,maxIter:-1,maxLine:-1});return l=.1/a,h=B(t,r,n,o,h[0],{eps:1e-4,maxIter:-1,maxLine:-1}),l=.01/a,(h=B(t,r,n,o,h[0],{eps:1e-4,maxIter:-1,maxLine:-1}))[0]}function v(t,r,n){t=new it(t),r=new it(r),n=new it(n);if(r.nbRows!=t.nbRows||n.nbRows!=t.nbRows)throw new Error("incompatible dimensions: "+t.nbRows+", "+r.nbRows+", "+n.nbRows);var o=it.xmy(n,r),i=it.xmy(t,r),e=o.vectorNorm("two");if(e<=1e-8)return r.toArray();var a=Math.max(0,Math.min(1,it.vectorDotProduct(o,i)/(e*e)));return it.axpby(1,r,a,o).toArray()}function M(t,r,n){var o=t;n||(o=t.slice(0).sort(function(t,r){return t-r}));var i=r*(t.length-1),e=Math.floor(i);return e==i?o[e]:o[e]+(o[e+1]-o[e])*(i-e)}function P(t,r,n,o){if(this.n=t,this.x="function"==typeof Float64Array?new Float64Array(t):new Array(t),this.reuseOutputArray=o,this.l=r,!this.l){this.l="function"==typeof Float64Array?new Float64Array(this.n):new Array(this.n);for(var i=0;i<this.n;++i)this.l[i]=0}if(this.u=n,!this.u){this.u="function"==typeof Float64Array?new Float64Array(this.n):new Array(this.n);for(i=0;i<this.n;++i)this.u[i]=1}for(i=0;i<this.n;++i)if(this.l[i]>this.u[i])throw new Error("empty box detected: lower bound strictly greater than upper bound");this.sample=function(){for(var t=0;t<this.n;++t)this.x[t]=Math.random()*(this.u[t]-this.l[t])+this.l[t];return this.reuseOutputArray?this.x:this.x.slice(0)}}function D(t,r){r=r||function(t,r){return t-r};for(var n=t.length,o=t[0],i=0,e=1;e<n;++e)0<r(t[e],o)&&(o=t[e],i=e);return[o,i]}function W(t,r,n){n=n||function(t,r){return t-r};var o=t.length,i="function"==typeof UInt32Array?new UInt32Array(10):new Array(10),e="function"==typeof UInt32Array?new UInt32Array(10):new Array(10),a=0,s=0,u=o-1;for(r=r-1;;)if(600<u-s&&a<10){var l=u-s+1,h=r-s+1,f=l,m=Math.log(f),c=Math.floor(.5*Math.exp(2*m/3)+.5),d=f/2<=h?1:-1,w=.5*Math.sqrt(m*c*(1-c/f))*d+.5;w=-1<w&&w<1?0:1<=w?Math.floor(w):Math.ceil(w),h==l/2&&(w=0),i[a]=s,e[a]=u,a++;var p=r-h*(c/f)+w;s<p&&(s=Math.floor(p+.5)),p+c<u&&(u=Math.floor(p+c+.5))}else{if(u<=s){if(0==a)return t[r];s=i[--a],u=e[a]}var v=t[r];for(h=s,j=u,t[r]=t[s],n(t[s]=v,t[u])<0&&(t[s]=t[u],t[u]=v);h<j;){var b=t[j];for(t[j]=t[h],t[h]=b,++h,--j;n(t[h],v)<0;)++h;for(;0<n(t[j],v);)--j}if(0==n(t[s],v)){b=t[s];t[s]=t[j],t[j]=b}else{++j;b=t[j];t[j]=t[u],t[u]=b}j<=r&&(s=j+1),r<=j&&(u=j-1)}}function p(t){var r=Math.pow(2,-52),n=(2-r)*Math.pow(2,1023),o=Math.pow(2,-1022);if(t!=t)return t;if(t===-1/0)return-n;if(t===1/0)return 1/0;if(t===+n)return 1/0;var i=t*(t<0?1-r/2:1+r);i===t&&(i=0<o*r?t+o*r:t+o),i===1/0&&(i=+n);var e=t+(i-t)/2;t<e&&e<i&&(i=e);var a=(i+t)/2;return t<a&&a<i&&(i=a),0===i?-0:i}function f(t,r){var n=0,o=Math.abs(t),i=Math.abs(r);return n=i<o?(n=r/t,o*Math.sqrt(1+n*n)):0!=r?(n=t/r,i*Math.sqrt(1+n*n)):0}function d(t,r){for(var n=new Array(t.length),o=0;o<t.length;++o)n[o]=[t[o],o];0==r?n.sort(function(t,r){return t[0]>r[0]?-1:1}):1==r&&n.sort(function(t,r){return t[0]<r[0]?-1:1});var i=new Array(t.length);for(o=i[n[0][1]]=1;o<t.length;++o)n[o][0]==n[o-1][0]?i[n[o][1]]=i[n[o-1][1]]:i[n[o][1]]=o+1;return i}function b(t,r){void 0===(r=r)&&(r=.5);for(var n=[],o=(t=new it(t)).nbRows,i=new Array(o),e=0;e<i.length;++e)i[e]=e+1;for(;0!=i.length;){if(1===i.length){var a=[i[0]];i[0]=null,n.push(a)}else{var s=t.submatrix(i,i).toRowArray(function(t,r,n){return t!=r}),u=new Array(i);for(e=0;e<i.length;++e)u[e]=I(s[e]);var l=0,h=-1,f=-1,m=0,c=-1,d=1;for(e=0;e<i.length;++e)u[e]>=f&&(l=i[e],f=u[h=e]),u[e]<=d&&(m=i[e],d=u[c=e]);if(t.getValueAt(l,m)>r){var w=l===m?[l]:[l,m];i[h]=null,i[c]=null;for(e=0;e<i.length;++e){if(null!==i[e])r<(t.getValueAt(i[e],l)+t.getValueAt(i[e],m))/2&&(w.push(i[e]),i[e]=null)}n.push(w)}else{var p=[l];i[h]=null;for(e=0;e<i.length;++e)null!==i[e]&&t.getValueAt(i[e],l)>r&&(p.push(i[e]),i[e]=null);if(n.push(p),l!==m){var v=[m];i[c]=null;for(e=0;e<i.length;++e)null!==i[e]&&t.getValueAt(i[e],m)>r&&(v.push(i[e]),i[e]=null);n.push(v)}}}var b=[];for(e=0;e<i.length;++e)null!==i[e]&&b.push(i[e]);i=b}return n}function I(t){for(var r,n=t.length,o=0,i=0;i<n;++i)o+=t[i];r=o/n;var e=0;for(i=0;i<n;++i)e+=t[i]-r;return(o+e)/n}function n(t){for(var r=t.length,n=I(t),o=0,i=0,e=0;e<r;++e){var a=t[e]-n;o+=a*a,i+=a}return(o-i*i/r)/r}function w(t){return Math.sqrt(function(t){var r=t.length;return n(t)*r/(r-1)}(t))}function _(t){var r=t,n=0,o=t,i=t*t,e=1;if(t<-8)return 0;if(8<t)return 1;for(;r!=n;)r=(n=r)+(o*=i/(e+=2));return.5+r*Math.exp(-.5*i-.9189385332046728)}function S(t,r){null==t&&(t=0),null==r&&(r=1);for(var n=Math.random();0===n;)n=Math.random();return t+r*s(n)}function e(t,r){null==t&&(t=0),null==r&&(r=1);for(var n,o=r*r,i=1.136717791056118,e=(1-i*i)/i*r,a=r*Math.sqrt(Math.PI/2);;){var s;if(t<e){var u=(-t+Math.sqrt(t*t+4*o))/2/o;n=-Math.log(1-Math.random())/u,s=Math.exp(-(n-t)*(n-t)/2/o-u*(t-n+u*o/2))}else if(t<=0)s=0<=(n=Math.abs(S())*r+t)?1:0;else if(t<a){var l=Math.random()<t/(t+Math.sqrt(Math.PI/2)*r)?1:0;n=l*(Math.random()*t)+(1-l)*(Math.abs(S()*r)+t),s=l*Math.exp(-(n-t)*(n-t)/2/o)+(1-l)}else s=0<=(n=S()*r+t)?1:0;if(Math.random()<=s)break}return n}function s(t){if(t<=0||1<=t){if(0==t)return-1/0;if(1==t)return 1/0;throw"The probality p must be bigger than 0 and smaller than 1"}var r,n=t-.5;if(Math.abs(n)<=.425){r=n*(((((((2509.0809287301227*(o=.180625-n*n)+33430.57558358813)*o+67265.7709270087)*o+45921.95393154987)*o+13731.69376550946)*o+1971.5909503065513)*o+133.14166789178438)*o+3.3871328727963665)/(((((((5226.495278852854*o+28729.085735721943)*o+39307.89580009271)*o+21213.794301586597)*o+5394.196021424751)*o+687.1870074920579)*o+42.31333070160091)*o+1)}else{var o;if(o=n<0?t:1-t,(o=Math.sqrt(-Math.log(o)))<=5)r=(((((((.0007745450142783414*(o-=1.6)+.022723844989269184)*o+.2417807251774506)*o+1.2704582524523684)*o+3.6478483247632045)*o+5.769497221460691)*o+4.630337846156546)*o+1.4234371107496835)/(((((((1.0507500716444169e-9*o+.0005475938084995345)*o+.015198666563616457)*o+.14810397642748008)*o+.6897673349851)*o+1.6763848301838038)*o+2.053191626637759)*o+1);else r=(((((((2.0103343992922881e-7*(o-=5)+27115555687434876e-21)*o+.0012426609473880784)*o+.026532189526576124)*o+.29656057182850487)*o+1.7848265399172913)*o+5.463784911164114)*o+6.657904643501103)/(((((((20442631033899397e-31*o+1.421511758316446e-7)*o+18463183175100548e-21)*o+.0007868691311456133)*o+.014875361290850615)*o+.1369298809227358)*o+.599832206555888)*o+1);n<0&&(r=-r)}return r}function V(t,r){this.n=t,this.x="function"==typeof Float64Array?new Float64Array(t):new Array(t),this.reuseOutputArray=r,this.sample=function(){for(var t=0,r=1,n=0;n<this.n;++n){var o=S();this.x[n]=o;var i=Math.abs(o);0!=i&&(t<i?(r=1+r*(t/o)*(t/o),t=i):r+=o/t*(o/t))}var e=t*Math.sqrt(r);for(n=0;n<this.n;++n)this.x[n]=this.x[n]/e;return this.reuseOutputArray?this.x:this.x.slice(0)}}function F(t,r){for(var n=t.length,o=I(t),i=I(r),e=0,a=0,s=0,u=0;u<n;++u){var l=t[u]-o,h=r[u]-i;e+=l*h,a+=l,s+=h}return(e-a*s/n)/n}function O(t,r){var n=t.length;return F(t,r)*n/(n-1)}function T(t,r,n){void 0===n&&(n={});var o=n.nRounds;void 0===o&&(o=10);var i=n.nSteps;void 0===i&&(i=5e3);var e=n.nDeltas;void 0===e&&(e=i);var v=n.neighbourGenerator,a=n.neighbourGeneratorParameters;void 0===v&&(v=function(t,r){for(var n=r.alpha,o=r.lowerBounds,i=r.upperBounds,e=t.length,a=t.slice(),s=t.slice(),u=0;u<e;++u)a[u]=t[u]-n/2,s[u]=t[u]+n/2,o&&(a[u]=Math.max(a[u],o[u])),i&&(s[u]=Math.min(s[u],i[u]));return{xx:new P(e,a,s).sample()}},void 0!==a&&void 0!==a.alpha||(a={alpha:.001}));r.nbRows;for(var s=function(t,r,n,o,i){for(var e=r,a=t(e),s=a.f_x,u=a.f_x_context,l="function"==typeof Float64Array?new Float64Array(o):new Array(o),h=0;h<o;++h){var f=v(e.slice(),n),m=f.xx,c=t(m,{x_c:e,f_x_c:s,f_x_c_context:u,x_c_updatedIndexes:f.x_updated_indexes}),d=c.f_x,w=c.f_x_context;l[h]=Math.abs(s-d),e=m,s=d,u=w}l.sort(function(t,r){return t-r});var p="function"==typeof Float64Array?new Float64Array(i):new Array(i);for(h=0;h<i;++h)p[h]=M(l,(i-(h+1))/i,!0);return p[i-1]=0,p}(t,r,a,e,o),u=r,l=t(u),h=l.f_x,f=l.f_x_context,m=u,c=h,d=0;d<o;++d)for(var w=0;w<i;++w){var p=v(u.slice(),a),b=p.xx,y=t(b,{x_c:u,f_x_c:h,f_x_c_context:f,x_c_updatedIndexes:p.x_updated_indexes}),g=y.f_x,x=y.f_x_context;g-h<s[d]&&(u=b,h=g,f=x),g<c&&(c=g,m=b)}return[m,c]}function c(t,r,n,o){void 0===o&&(o={});var i=o.maxIter;void 0===i&&(i=-1);var e=o.eps;void 0===e&&(e=1e-6);var a=(Math.sqrt(5)-1)/2,s=r,u=n,l=u-a*(u-s),h=s+a*(u-s),f=t(r),m=t(n),c=t(l),d=t(h);if(n<r)throw new Error("bracketing interval lower bound "+r+" greater than bracketing interval upper bound "+n);for(var w=0;;){if(-1!==i&&i<w)throw new Error("maximum number of iterations reached: "+i);if(++w,c<=d?(u=h,h=l,d=c,c=t(l=u-a*(u-s))):d<c&&(s=l,l=h,c=d,d=t(h=s+a*(u-s))),Math.abs(u-s)<=e)return c<d?f<c?[r,f]:[l,c]:m<d?[n,m]:[h,d]}}function q(t,r,n,o){void 0===o&&(o={});var i=o.maxIter;void 0===i&&(i=45);var e=o.eps;void 0===e&&(e=1e-6);var a=o.outputInterval;void 0===a&&(a=!1);var s,u,l=t(r),h=t(n);if(n<=r)throw new Error("bracketing interval lower bound "+r+" greater than bracketing interval upper bound "+n);if(0==l)return a?[r,r+e]:r;if(0==h)return a?[n-e,n]:n;if(0<l*h)throw new Error("interval ["+r+","+n+"] is not a bracketing interval");u=l<=0?n-(s=r):r-(s=n);for(var f=0;;){if(-1!==i&&i<f)throw new Error("maximum number of iterations reached: "+i);++f;var m=s+(u/=2),c=t(m);if(c<=0&&(s=m),Math.abs(u)<=e||0==c)return a?[Math.max(r,s-e/2),Math.min(n,s+e/2)]:s}}function B(r,t,n,i,o,e){function a(t){return r(t)+n(t)}function s(t,r,n){var o=it.axpby(1,r,-t,n);return[o,it.copy(i(o,t))]}void 0===e&&(e={});for(var u,l,h,f,m,c,d,w,p,v,b,y,g,x,C,R,E=e.eps||1e-4,A=e.maxIter||1e4,M=e.maxLine||100,P=e.beta||.5,_=e.alphaMin||1e-10,z=e.alphaMax||1e10,k=e.restartPeriod||1e3,I=o.nbRows,S=1e-12,F=.5,V=_,O=it.zeros(I,1),T=it.zeros(I,1),N=it.zeros(I,1),D=it.zeros(I,1),U=it.zeros(I,1),W=!0,q=0;;){if(-1!==A&&A<q)throw new Error("maximum number of iterations reached: "+A);++q%k==0&&(o=m,W=!0),!0===W&&(u=0,h=l=1,f=null,new it(c=new it(m=new it(o))),d=it.zeros(I,1),O=it.copy(t(m),O),T=it.copy(O,T),N=it.copy(T,N),w=it.zeros(I,1),D=it.copy(m,D),U=it.copy(O,U),W=!1);for(var B=V,L=s(B,D,U),G=L[0],j=L[1],H=0;a(j)>(p=B,v=j,y=U,x=void 0,g=r(b=D),x=it.xmy(v,b),C=x.vectorNorm("two"),R=n(v),g+it.vectorDotProduct(x,y)+1/(2*p)*C*C+R+S);){if(-1!==M&&M<H)throw new Error("maximum number of line searches reached: "+M+" at iteration: "+q);++H,B*=P,h/=P,l=(1+Math.sqrt(1+4*h*u*u))/2,G=(L=s(B,D=it.axpby(1,c,(u-1)/l,d,D),U=it.axpby(1,T,(u-1)/l,w,U)))[0],j=L[1]}O=it.copy(t(m=j),O);var Y=it.xmy(m,c),K=it.xmy(O,T),Z=it.vectorDotProduct(Y,Y),J=Math.max(it.vectorDotProduct(K,K),S),Q=it.vectorDotProduct(Y,K);if(Q<=S)mu_kp_0=z;else{var X=Math.max(_,Math.min(Z/Q,z)),$=Math.max(_,Math.min(Q/J,z));$/X<=F?(mu_kp_0=$,F*=.9):(mu_kp_0=X,F*=1.1)}f=B/mu_kp_0;var tt=(1+Math.sqrt(1+4*f*l*l))/2,rt=it.axpby(1,m,(l-1)/tt,Y),nt=it.axpby(1,O,(l-1)/tt,K),ot=it.axpby(1/B,G,-1/B,m);if(it.xpy(O,ot).vectorNorm("infinity")<=E)break;S<=it.vectorDotProduct(it.xmy(D,m),Y)&&(o=m,W=!0),V=mu_kp_0,c,c=m,d=Y,N=it.copy(T,N),T=it.copy(O,T),w=K,D=it.copy(rt,D),U=it.copy(nt,U),h=f,u=l,l=tt}return[m,a(m)]}function L(a,s,u,t,l,h,r){function n(t,r){return t instanceof Array?(t.length=r,t):t instanceof Float64Array||t instanceof Int32Array?t.subarray(0,r):void 0}function o(t){for(var r=v-t*b+y,n=new p.iterator,o=n.next();0!=o;){var i,e=o-1;t<=w[e]?i=h.data[e]:w[e]<=t&&t<=d[e]?i=(s.data[e]-t*u.data[e])/a.data[e]:d[e]<=t&&(i=l.data[e]),r+=u.data[e]*i,o=n.next()}return r}void 0===r&&(r={});var i=r.eps||1e-16,e=r.outputLagrangeMultiplier;if(!(a instanceof it&&a.isVector()))throw new Error("first input must be a vector");if(!(s instanceof it&&s.isVector()))throw new Error("second input must be a vector");if(!(u instanceof it&&u.isVector()))throw new Error("third input must be a vector");if(!(l instanceof it&&l.isVector()))throw new Error("fifth input must be a vector");if(!(h instanceof it&&h.isVector()))throw new Error("sixth input must be a vector");if(a.nbRows!==s.nbRows)throw new Error("first and second inputs number of rows do not match: "+a.nbRows+"-"+s.nbRows);if(a.nbRows!==u.nbRows)throw new Error("first and third inputs number of rows do not match: "+a.nbRows+"-"+u.nbRows);if(a.nbRows!==l.nbRows)throw new Error("first and fifth inputs number of rows do not match: "+a.nbRows+"-"+l.nbRows);if(a.nbRows!==h.nbRows)throw new Error("first and sixth inputs number of rows do not match: "+a.nbRows+"-"+h.nbRows);for(var f=u.nbRows,m=Math.abs(t),c="function"==typeof Float64Array?new Float64Array(2*f):new Array(2*f),d="function"==typeof Float64Array?new Float64Array(f):new Array(f),w="function"==typeof Float64Array?new Float64Array(f):new Array(f),p=(new nt).setRange(1,f),v=0,b=0,y=0,g=1/0,x=-1/0,C=0,R=0;C<f;++C){if(l.data[C]>h.data[C])throw new Error("infeasible problem detected");if(u.data[C]<=0)throw new Error("negative element detected in b");if(a.data[C]<=0)throw new Error("negative element detected in d");var E=(s.data[C]-l.data[C]*a.data[C])/u.data[C];d[C]=E,c[R++]=E;var A=(s.data[C]-h.data[C]*a.data[C])/u.data[C];w[C]=A,x<E&&(x=E),(c[R++]=A)<g&&(g=A)}var M=o(g),P=o(x);if(M<t||t<P)throw new Error("infeasible problem detected");var _=null;if(Math.abs(M-t)<=i*m)_=g;else if(Math.abs(M-t)<=i*m)_=x;else{for(var z=g,k=x;0!=c.length;){var I=Math.ceil(c.length/2),S=W(c,I),F=o(S);if(Math.abs(F-t)<=i*m){_=S;break}if(t<F){z=S;for(R=0,C=I;C<c.length;++C)c[R++]=c[C];c=n(c,R)}else F<t&&(k=S,c=n(c,I-1));for(var V=new p.iterator,O=V.next();0!=O;){var T=!1;if(d[C=O-1]<=z&&(y+=u.data[C]*l.data[C],T=!0),k<=w[C]&&(y+=u.data[C]*h.data[C],T=!0),w[C]<=z&&k<=d[C]){var N=u.data[C]/a.data[C];v+=s.data[C]*N,b+=u.data[C]*N,T=!0}!0===T&&p.unset(C+1),O=V.next()}}0==c.length&&(_=(v+y-t)/b)}var D=function(){for(var t=it.zeros(f,1),r=0;r<f;++r){var n;_<=w[r]?n=h.data[r]:w[r]<=_&&_<=d[r]?n=(s.data[r]-_*u.data[r])/a.data[r]:d[r]<=_&&(n=l.data[r]),t.data[r]=n}return t}(),U=.5*it.vectorDotProduct(D,it.elementwiseProduct(D,a))-it.vectorDotProduct(s,D);return!0===e?[D,U,_]:[D,U]}function G(t,r,n,o,i,e,s){void 0===s&&(s={});var u=s.eps;null==u&&(u=1e-4);var l=s.maxIter;null==l&&(l=1e4);var h=s.antiCycling;null==h&&(h=!1);var f=s.x0;if(!(t instanceof it&&t.isSquare()))throw new Error("first input must be a square matrix");if(!(r instanceof it&&r.isVector()))throw new Error("second input must be a vector");if(!(n instanceof it&&n.isVector()))throw new Error("third input must be a vector");if(!(i instanceof it&&i.isVector()))throw new Error("fifth input must be a vector");if(!(e instanceof it&&e.isVector()))throw new Error("sixth input must be a vector");if(t.nbRows!==r.nbRows)throw new Error("first and second inputs number of rows do not match: "+t.nbRows+"-"+a.nbRows);if(t.nbRows!==n.nbRows)throw new Error("first and third inputs number of rows do not match: "+t.nbRows+"-"+n.nbRows);if(t.nbRows!==i.nbRows)throw new Error("first and fifth inputs number of rows do not match: "+t.nbRows+"-"+i.nbRows);if(t.nbRows!==e.nbRows)throw new Error("first and sixth inputs number of rows do not match: "+t.nbRows+"-"+e.nbRows);var m,c=t.nbRows;if(null==f){var d=it.fill(c,1,function(t,r){return o/c*1/n.data[t-1]});m=L(it.ones(c,1),d,n,o,i,e)[0]}else m=new it(f);for(var w=it.xpy(it.xy(t,m),r),p=1==h?new U(c,void 0,!0):void 0,v=0;;){if(-1!==l&&l<=v)throw new Error("maximum number of iterations reached: "+l);++v;var b,y=-1,g=-1/0,x=-1,C=1/0;1==h&&(b=p.next());for(var R=0;R<c;++R){var E=R;1==h&&(E=b[R]-1),F_i=w.data[E]/n.data[E],i.data[E]<m.data[E]&&m.data[E]<e.data[E]?(F_i>g&&(g=F_i,y=E),F_i<C&&(C=F_i,x=E)):m.data[E]==i.data[E]?F_i<C&&(C=F_i,x=E):m.data[E]==e.data[E]&&F_i>g&&(g=F_i,y=E)}if(g-C<=u)break;E=x,R=y;var A,M=(i.data[E]-m.data[E])*n.data[E],P=(m.data[R]-e.data[R])*n.data[R],_=P<=M?M:P,z=(e.data[E]-m.data[E])*n.data[E],k=(m.data[R]-i.data[R])*n.data[R],I=z<=k?z:k,S=C-g,F=t.data[E*t.nbColumns+E]/(n.data[E]*n.data[E])+t.data[R*t.nbColumns+R]/(n.data[R]*n.data[R])-2*t.data[E*t.nbColumns+R]/(n.data[E]*n.data[R]);if(0<F)I<(A=-S/F)?A=I:A<_&&(A=_);else{if(0!=F)throw new Error("internal error: the input matrix might not be positive semi-definite");A=0<S?_:I}var V=m.data[E],O=m.data[R],T=A/n.data[E],N=-A/n.data[R];m.data[E]+=T,m.data[R]+=N,A==_&&(_==M&&(m.data[E]=i.data[E],T=m.data[E]-V),_==P&&(m.data[R]=e.data[R],N=m.data[R]-O)),A==I&&(I==z&&(m.data[E]=e.data[E],T=m.data[E]-V),I==k&&(m.data[R]=i.data[R],N=m.data[R]-O));for(var D=0;D<c;++D)w.data[D]=w.data[D]+t.data[D*t.nbColumns+E]*T+t.data[D*t.nbColumns+R]*N}return[m,.5*it.vectorDotProduct(m,it.xy(t,m))+it.vectorDotProduct(r,m)]}function m(o,t,i,r,n,e,a,s){void 0===s&&(s={});var u=s.eps||1e-8,l=s.maxIter||1e5,h=!1,f=!1,m=!1;if(null!==o&&null!==t)h=!0;else{if(null!==o&&null===t)throw new Error("equality constraints vector is missing");if(null===o&&null!==t)throw new Error("equality constraints matrix is missing")}if(null!==i&&null!==r)f=!0;else{if(null!==i&&null===r)throw new Error("inequality constraints vector is missing");if(null===i&&null!==r)throw new Error("inequality constraints matrix is missing")}if(null!==e&&null!==a)m=!0;else{if(null!==e&&null===a)throw new Error("upper bounds constraints vector is missing");if(null===e&&null!==a)throw new Error("lower bounds constraints vector is missing")}if(!(n instanceof it))throw new Error("fifth input must be a matrix");if(1!==n.nbColumns)throw new Error("fifth input is not a vector: "+n.nbColumns+"-"+n.nbRows);if(h){if(!(o instanceof it))throw new Error("first input must be a matrix");if(!(t instanceof it))throw new Error("second input must be a matrix");if(o.nbRows!==t.nbRows)throw new Error("first and second inputs number of rows do not match: "+o.nbRows+"-"+t.nbRows);if(o.nbColumns!==n.nbRows)throw new Error("first input number of columns and fifth input number of rows do not match: "+o.nbColumns+"-"+n.nbRows);if(1!==t.nbColumns)throw new Error("second input is not a vector: "+t.nbColumns+"-"+t.nbRows)}if(f){if(!(i instanceof it))throw new Error("third input must be a matrix");if(!(r instanceof it))throw new Error("third input must be a matrix");if(i.nbRows!==r.nbRows)throw new Error("third and fourth inputs number of rows do not match: "+i.nbRows+"-"+r.nbRows);if(i.nbColumns!==n.nbRows)throw new Error("third input number of columns and fifth input number of rows do not match: "+i.nbColumns+"-"+n.nbRows);if(1!==r.nbColumns)throw new Error("fourth input is not a vector: "+r.nbColumns+"-"+r.nbRows)}if(m){if(null!==e.nbRows){if(!(e instanceof it))throw new Error("sixth input must be a matrix");if(e.nbRows!==n.nbRows)throw new Error("sixth input number of rows and fifth input number of rows do not match: "+e.nbRows+"-"+n.nbRows)}if(null!==a.nbRows){if(!(a instanceof it))throw new Error("seventh input must be a matrix");if(a.nbRows!==n.nbRows)throw new Error("seventh input number of rows and fifth input number of rows do not match: "+a.nbRows+"-"+n.nbRows)}}var c=0,d=null,w=null,p=null;h&&(c=o.nbRows,d=it.zeros(c,1),w=it.zeros(c,1),p=it.zeros(c,1));var v=0,b=null,y=null,g=null;f&&(v=i.nbRows,b=it.zeros(v,1),y=it.zeros(v,1),g=it.zeros(v,1));var x=n.nbRows,C=it.ones(x,1),R=it.ones(x,1),E=it.ones(x,1),A=it.zeros(x,1),M=it.zeros(x,1),P=it.zeros(x,1),_=null;h&&(_=it.zeros(c,1));var z=null;f&&(z=it.zeros(v,1));var k=it.fill(x,1,function(t,r){var n=0;h&&(n+=o.vectorNorm("one","column",t));f&&(n+=i.vectorNorm("one","column",t));return 0==n&&(n=1),.9995/n}),I=null;h&&(I=it.fill(c,1,function(t,r){var n=o.vectorNorm("one","row",t);return 0==n&&(n=1),.9995/n}));var S=null;f&&(S=it.fill(v,1,function(t,r){var n=i.vectorNorm("one","row",t);return 0==n&&(n=1),.9995/n}));for(var F=0;;){if(-1!==l&&l<=F)throw new Error("maximum number of iterations reached: "+l);if(++F,h&&f?R=it.xpy(it.xpy(it.txy(o,d,M),it.txy(i,b,P),M),n,R):h?R=it.xpy(it.txy(o,d,M),n,R):f&&(R=it.xpy(it.txy(i,b,M),n,R)),R=it.xmy(C,it.elementwiseProduct(R,k,M),R),m)for(var V=1;V<=x;++V)R.data[V-1]<e.data[V-1]?R.data[V-1]=e.data[V-1]:R.data[V-1]>a.data[V-1]&&(R.data[V-1]=a.data[V-1]);else for(V=1;V<=x;++V)R.data[V-1]<0&&(R.data[V-1]=0);if(E=it.axpby(2,R,-1,C,E),h&&(w=it.xpy(d,it.elementwiseProduct(it.xmy(it.xy(o,E,_),t,_),I,_),w)),f){y=it.xpy(b,it.elementwiseProduct(it.xmy(it.xy(i,E,z),r,z),S,z),y);for(V=1;V<=v;++V)y.data[V-1]<0&&(y.data[V-1]=0)}var O=(A=it.xmy(R,C,A)).vectorNorm("infinity"),T=R.vectorNorm("infinity"),N=0,D=0;h&&(N=(p=it.xmy(w,d,p)).vectorNorm("infinity"),D=w.vectorNorm("infinity"));var U=0,W=0;if(f&&(U=(g=it.xmy(y,b,g)).vectorNorm("infinity"),W=y.vectorNorm("infinity")),O<=u*T&&N<=u*D&&U<=u*W)break;C=it.copy(R,C),h&&(d=it.copy(w,d)),f&&(b=it.copy(y,b))}return[R,it.vectorDotProduct(n,R)]}function ot(n,t,r){var o=(n=new it(n)).nbRows;t=t?new it(t):it.zeros(o,1),r=r?new it(r):it.ones(o,1);Y(o,t.toArray(),r.toArray());for(var i="function"==typeof Uint32Array?new Uint32Array(o):new Array(o),e=0;e<o;++e)i[e]=e+1;i.sort(function(t,r){return n.getValue(t,1)-n.getValue(r,1)});for(var a=new it(t),s=1-a.sum(),u=-1,l=0;l<o&&!(Math.abs(s)<=1e-16);++l){u=i[l];var h=a.getValue(u,1);s>=r.getValue(u,1)-h?(a.setValue(u,1,r.getValue(u,1)),s-=r.getValue(u,1)-h):(a.setValue(u,1,h+s),s=0)}return[a.toArray(),it.vectorDotProduct(n,a)]}function H(t,r,n){var o=t.length;Y(o,r,n);for(var i=0,e=0;e<o;++e){var a=0;r&&(a=r[e]);var s=1;n&&(s=n[e]);var u=t[e];if(u<a||s<u)return Number.POSITIVE_INFINITY;i+=u}return 1e-12<Math.abs(i-1)?Number.POSITIVE_INFINITY:0}function l(t,r,n){for(var o=0,i=0,e=0;e<t;++e){var a=0;r&&(a=r[e]);var s=1;if(n&&(s=n[e]),s<a)throw new Error("infeasible problem detected: lower bound strictly greater than upper bound");if(a<0)throw new Error("incorrect problem detected: lower bound strictly lower than 0");if(1<s)throw new Error("incorrect problem detected: upper bound strictly greater than 1");o+=a,i+=s}if(1<o)throw new Error("infeasible problem detected: the restricted simplex is empty");return[o,i]}function Y(t,r,n){for(var o=0,i=0,e=0;e<t;++e){var a=0;r&&(a=r[e]);var s=1;if(n&&(s=n[e]),s<a)throw new Error("infeasible problem detected: lower bound strictly greater than upper bound");if(a<0)throw new Error("incorrect problem detected: lower bound strictly lower than 0");if(1<s)throw new Error("incorrect problem detected: upper bound strictly greater than 1");o+=a,i+=s}if(1<o||i<1)throw new Error("infeasible problem detected: the restricted simplex is empty");return[o,i]}function K(t,e,a){var r=t.length;l(r,e,a);var n=new it(t).elemMap(function(t,r,n){var o=e?e[t-1]:0,i=a?a[t-1]:1;return Math.max(-o,Math.min(i,n))}),o=it.ones(r,1);return it.vectorDotProduct(o,n)<=1?n.toArray():Z(t,e,a)}function Z(t,r,n){var o=t.length;Y(o,r,n);for(var i=it.ones(o,1),e=new it(t),a=it.ones(o,1),s=r?new it(r):it.zeros(o,1),u=n?new it(n):it.ones(o,1),l=L(i,e,a,1,s,u),h=l[0].toArray();H(h,r,n)==Number.POSITIVE_INFINITY;)h=(l=L(i,e=new it(h),a,1,s,u))[0].toArray();return h}function J(t,r,n){this.n=t,this.k=r,this.reuseOutputArray=n,this.x="function"==typeof Float64Array?new Float64Array(t):new Array(t),this.compositionIterator=new o(r,t,!0),this.sample=function(){var t=this.compositionIterator.next();if(-1==t)return-1;for(var r=0;r<this.n;++r)this.x[r]=t[r]/this.k;return this.reuseOutputArray?this.x:this.x.slice(0)}}function Q(l,t,r,n){if(this.n=l,this.x="function"==typeof Float64Array?new Float64Array(l):new Array(l),this.u="function"==typeof Float64Array?new Float64Array(l-1):new Array(l-1),this.randomGenerator=function(t){for(var r=0;r<this.n;++r)t[r]=Math.random()},n){if("function"!=typeof n)throw new Error("the random number generator must be a function");this.randomGenerator=n}if(t&&(this.lowerBounds=t,!r)){this.upperBounds="function"==typeof Float64Array?new Float64Array(l):new Array(l);for(var o=0;o<this.n;++o)this.upperBounds[o]=1}if(r&&(this.upperBounds=r,!t)){this.lowerBounds="function"==typeof Float64Array?new Float64Array(l):new Array(l);for(o=0;o<this.n;++o)this.lowerBounds[o]=0}if(this.lowerBounds||this.upperBounds){var i=Y(l,this.lowerBounds,this.upperBounds);if(this.sumLowerBounds=i[0],this.sumUpperBounds=i[1],1==this.sumLowerBounds||1==this.sumUpperBounds);else{var e=0,a=0;for(o=0;o<this.n;++o){var s=this.lowerBounds[o],u=this.upperBounds[o],h=Math.max(s,u+1-this.sumUpperBounds),f=Math.min(u,s+1-this.sumLowerBounds);e+=this.lowerBounds[o]=h,a+=this.upperBounds[o]=f}this.sumLowerBounds=e,this.sumUpperBounds=a,this.upperStarBounds="function"==typeof Float64Array?new Float64Array(l):new Array(l),this.runningSumUpperStarBounds="function"==typeof Float64Array?new Float64Array(l):new Array(l);var m=0;for(o=0;o<this.n;++o)this.upperStarBounds[o]=(this.upperBounds[o]-this.lowerBounds[o])/(1-this.sumLowerBounds),m+=this.upperStarBounds[o],this.runningSumUpperStarBounds[o]=m}}this.sample_no_bounds=function(){for(var t=0,r=0;r<this.n;++r){var n=1-Math.random(),o=Math.log(n);t+=this.x[r]=o}for(r=0;r<this.n;++r)this.x[r]=this.x[r]/t;return this.x.slice(0)},this.sample_binding_bounds=function(){var t=null;if(1==this.sumLowerBounds)t=this.lowerBounds;else{if(1!=this.sumUpperBounds)throw new Error("internal error");t=this.upperBounds}for(var r=0;r<this.n;++r)this.x[r]=t[r];return this.x.slice(0)},this.sample_with_bounds=function(){this.randomGenerator(this.u);for(var t=this.u,r=1,n=l;2<=n;--n){if(Math.abs(r)<=1e-14){for(var o=n;1<=o;--o)this.x[o-1]=0;break}var i=t[n-2],e=Math.max(0,1-this.runningSumUpperStarBounds[n-2]/r),a=Math.min(1,this.upperStarBounds[n-1]/r),s=r*(1-Math.pow(i*Math.pow(1-a,n-1)+(1-i)*Math.pow(1-e,n-1),1/(n-1)));r-=this.x[n-1]=s}1==n&&(this.x[0]=r);for(var u=0;u<this.n;++u)this.x[u]=(1-this.sumLowerBounds)*this.x[u]+this.lowerBounds[u];return this.x.slice(0)},this.lowerBounds||this.upperBounds?1==this.sumLowerBounds||1==this.sumUpperBounds?this.sample=this.sample_binding_bounds:this.sample=this.sample_with_bounds:this.sample=this.sample_no_bounds}function u(t,r,n,o,i){var e=null,a=null;if(o&&(e=o,!i)){a="function"==typeof Float64Array?new Float64Array(r):new Array(r);for(var s=0;s<r;++s)a[s]=1}if(i&&(a=i,!o)){e="function"==typeof Float64Array?new Float64Array(r):new Array(r);for(s=0;s<r;++s)e[s]=0}if(e||a)Y(r,e,a);for(var u=Number.POSITIVE_INFINITY,l=[],h=new J(r,n,!0),f=h.sample();-1!==f;){var m=!0;if(e)for(s=0;s<r;++s)if(e[s]>f[s]){m=!1;break}if(a)for(s=0;s<r;++s)if(f[s]>a[s]){m=!1;break}if(m){var c=t(f);c<u?(u=c,l=[f.slice(0)]):c==u&&l.push(f.slice(0)),f=h.sample()}else f=h.sample()}return l}function X(t,r,n){if(h.call(this,t,r,n),this.cornerPortfolios=function(t,n,r,o,i,e){var a=1e-8;function w(t){this.STATUS_UNDEF=-1,this.STATUS_IN=0,this.STATUS_LOW=1,this.STATUS_UP=2,this.nbAssets=t,this.varIn=new nt,this.varIn.resize(t),this.varLow=new nt,this.varLow.resize(t),this.varUp=new nt,this.varUp.resize(t),this.setIn=function(t){this.varIn.set(t),this.varLow.unset(t),this.varUp.unset(t)},this.setOnLowerBound=function(t){this.varLow.set(t),this.varIn.unset(t),this.varUp.unset(t)},this.setOnUpperBound=function(t){this.varUp.set(t),this.varIn.unset(t),this.varLow.unset(t)},this.isIn=function(t){return this.varIn.get(t)},this.isOnLowerBound=function(t){return this.varLow.get(t)},this.isOnUpperBound=function(t){return this.varUp.get(t)},this.isOut=function(t){return this.varLow.get(t)||this.varUp.get(t)},this.getInIndexes=function(){return this.varIn.toArray()},this.getOutIndexes=function(){return this.varLow.toArray().concat(this.varUp.toArray())}}function s(n,t,r,o,i){for(var e=t.nbRows,a="function"==typeof Uint32Array?new Uint32Array(e):new Array(e),s=0;s<e;++s)a[s]=s+1;a.sort(function(t,r){return n.getValue(r,1)-n.getValue(t,1)});for(var u,l=!0,h=1;h<e;++h)if(n.getValue(a[h],1)==n.getValue(a[h-1],1)){l=!1;break}1==l?u=new it(ot(n.elemMap(function(t,r,n){return-n}),r,o)[0]):u=new et(n,t,{optimizationMethodParams:{antiCyclingGsmo:!0,maximumRiskToleranceValueOnlyGsmo:!0,maxIterGsmo:-1},constraints:{minWeights:r,maxWeights:o}}).getHighestReturnPortfolio();var f=0,m=0,c=0,d=new w(e);for(h=1;h<=e;++h)Math.abs(u.getValue(h,1)-r.getValue(h,1))<=i?(d.setOnLowerBound(h),++m):Math.abs(u.getValue(h,1)-o.getValue(h,1))<=i&&o.getValue(h,1)<1-i?(d.setOnUpperBound(h),++c):(d.setIn(h),++f);return{weights:u,variablesStatusManager:d,nbAssetsLow:m,nbAssetsIn:f,nbAssetsUp:c}}void 0===e&&(e={constraints:{}});void 0===e.optimizationMethodParams&&(e.optimizationMethodParams={});var u=e.optimizationMethodParams.maxIterCriticalLine;null==u&&(u=1e3);var l=n.nbColumns,h=r,f=o,m=[],c=it.ones(1,l),d=c.nbRows,p=it.ones(1,1),v=it.fill(l,l+d,function(t,r){return r<=l?n.data[(t-1)*n.nbColumns+(r-1)]:c.data[(r-l-1)*c.nbColumns+(t-1)]}),b=s(t,n,h,f,i),y=b.weights,g=b.variablesStatusManager;{if(b.nbAssetsLow==l||b.nbAssetsUp==l){var x=new it(y);return m.push([x,0]),m}if(0==b.nbAssetsIn){var C=f.elemMap(function(t,r,n){return Math.min(n+1e-8,1)}),R=s(t,n,h,C,i);if(g=R.variablesStatusManager,0==R.nbAssetsIn)throw new Error("internal error: impossible to determine the IN variables associated to the maximum return portfolio")}}var E=0;for(;;){if(-1!==u&&u<=E)throw new Error("maximum number of iterations reached: "+u);++E;var A=g.getInIndexes(),M=g.getOutIndexes(),P=it.fill(l+d,l+d,function(t,r){return t<=l&&r<=l?g.isIn(t)?n.data[(t-1)*n.nbColumns+(r-1)]:t==r?1:0:l+1<=t&&r<=l?g.isIn(r)?c.data[(t-l-1)*c.nbColumns+(r-1)]:0:t<=l&&l+1<=r&&g.isIn(t)?c.data[(r-l-1)*c.nbColumns+(t-1)]:0}),_=it.fill(l,1,function(t,r){return g.isOnUpperBound(t)?f.data[t-1]:g.isOnLowerBound(t)?h.data[t-1]:0}),z=it.xy(c,_),k=it.fill(l+d,1,function(t,r){return t<=l?_.data[t-1]:p.data[t-l-1]-z.data[t-l-1]}),I=t.elemMap(function(t,r,n){return g.isIn(t)?n:0}),S=it.fill(l+d,1,function(t,r){return t<=l?I.data[t-1]:0});try{var F=it.luDecomposition(P),V=(F.lowerTriangular,F.upperTriangular,F.rowPermutation,F.columnPermutation,it.linsolveForwardSubstitution(F.lowerTriangular,it.xy(F.rowPermutation,k))),O=it.linsolveBackSubstitution(F.upperTriangular,V),T=it.xy(F.columnPermutation,O);V=it.linsolveForwardSubstitution(F.lowerTriangular,it.xy(F.rowPermutation,S)),O=it.linsolveBackSubstitution(F.upperTriangular,V);var N=it.xy(F.columnPermutation,O)}catch(t){throw new Error("internal error: impossible to solve the KKT system")}for(var D=it.xy(v,T),U=it.xmy(it.xy(v,N),t),W=-1,q=0,B=g.STATUS_UNDEF,L=1;L<=A.length;++L){var G=A[L-1],j=T.data[G-1],H=N.data[G-1];if(a<H){var Y=h.data[G-1];q<=(K=(Y-j)/H)&&(W=G,q=K,B=g.STATUS_LOW)}else if(H<-a){var K,Z=f.data[G-1];q<=(K=(Z-j)/H)&&(W=G,q=K,B=g.STATUS_UP)}}var J=-1,Q=0;for(L=1;L<=M.length;++L){var X=M[L-1],$=D.data[X-1],tt=U.data[X-1];if(g.isOnLowerBound(X)){if(a<tt)Q<=(rt=-$/tt)&&(J=X,Q=rt)}else{if(!g.isOnUpperBound(X))throw new Error("internal error: OUT variable neither on its lower of upper bound");var rt;tt<-a&&Q<=(rt=-$/tt)&&(J=X,Q=rt)}}lambda_e=Math.max(q,Q,0);x=it.fill(l,1,function(t,r){if(t<=l){var n=T.data[t-1]+lambda_e*N.data[t-1],o=h.data[t-1],i=f.data[t-1];return Math.max(Math.min(n,i),o)}});if(m.push([x,lambda_e]),lambda_e<a)break;Q<=q?B==g.STATUS_LOW?g.setOnLowerBound(W):g.setOnUpperBound(W):g.setIn(J)}return m}(this.mu,this.sigma,this.lowerBounds,this.upperBounds,this.epsBounds,n),0==this.cornerPortfolios.length)throw new Error("internal error: no corner portfolio could be computed")}function et(t,r,n){if(h.call(this,t,r,n),void 0===n&&(n={constraints:{}}),void 0===n.optimizationMethodParams&&(n.optimizationMethodParams={}),this.epsGsmo=n.optimizationMethodParams.epsGsmo,null==this.epsGsmo&&(this.epsGsmo=1e-6),this.maxIterationsGsmo=n.optimizationMethodParams.maxIterGsmo,null==this.maxIterationsGsmo&&(this.maxIterationsGsmo=1e4),this.antiCyclingGsmo=n.optimizationMethodParams.antiCyclingGsmo,null==this.antiCyclingGsmo&&(this.antiCyclingGsmo=!1),this.maximumRiskToleranceValueOnly=n.optimizationMethodParams.maximumRiskToleranceValueOnlyGsmo,null==this.maximumRiskToleranceValueOnly&&(this.maximumRiskToleranceValueOnly=!1),this.minimumRiskToleranceValueOnly=n.optimizationMethodParams.minimumRiskToleranceValueOnlyGsmo,null==this.minimumRiskToleranceValueOnly&&(this.minimumRiskToleranceValueOnly=!1),1==this.maximumRiskToleranceValueOnly&&1==this.minimumRiskToleranceValueOnly)throw new Error("internal error: inconsistent minimum/maximum risk tolerance values computation");if(this.cachedEfficientPortfolios=new Map,0==this.minimumRiskToleranceValueOnly){var o=function(){var t,n=this.nbAssets,r=this.mu,o=this.sigma,i=this.lowerBounds,e=this.upperBounds,a=-ot(r.elemMap(function(t,r,n){return-n}),i,e)[1],s=o,u=it.ones(n,1),l=i,h=e,f=it.fill(n,1,function(t,r){return 1/n}),m=L(it.ones(n,1),f,u,1,l,h)[0],c=0,d=32;do{if(54<++c)throw new Error("internal error: maximum number of iterations reached when searching for the efficient portfolio with maximum return");var w=it.ax(-(d*=2),r),p=G(s,w,u,1,l,h,{x0:m,antiCycling:this.antiCyclingGsmo,eps:this.epsGsmo,maxIter:this.maxIterationsGsmo});t=p[0];var v=this.computePortfolioReturn(t);this.cachedEfficientPortfolios.set(d,{weights:t,ret:v,volatility:this.computePortfolioVolatility(t)})}while(1e-12<Math.abs(v-a));return[t,d]}.call(this);this.highestRiskTolerance=o[1],this.highestRiskTolerancePortfolio=o[0],this.cachedEfficientPortfolios.set(this.highestRiskTolerance,{weights:this.highestRiskTolerancePortfolio,ret:this.getHighestReturn(),volatility:this.getHighestVolatility()})}if(0==this.maximumRiskToleranceValueOnly){var i=function(){var t,n=this.nbAssets,r=this.mu,o=this.sigma,i=this.lowerBounds,e=this.upperBounds,a=o,s=it.zeros(n,1),u=it.ones(n,1),l=i,h=e,f=it.fill(n,1,function(t,r){return 1/n}),m=L(it.ones(n,1),f,u,1,l,h)[0],c=G(a,s,u,1,l,h,{x0:m,antiCycling:this.antiCyclingGsmo,eps:this.epsGsmo,maxIter:this.maxIterationsGsmo}),d=this.computePortfolioVolatility(c[0]),w=2;do{s=it.ax(-(w/=2),r);var p=G(a,s,u,1,l,h,{x0:m,antiCycling:this.antiCyclingGsmo,eps:this.epsGsmo,maxIter:this.maxIterationsGsmo});t=p[0];var v=this.computePortfolioVolatility(t);this.cachedEfficientPortfolios.set(w,{weights:t,ret:this.computePortfolioReturn(t),volatility:v})}while(1e-12<Math.abs(v-d));return[t,w]}.call(this);this.lowestRiskTolerance=i[1],this.lowestRiskTolerancePortfolio=i[0],this.cachedEfficientPortfolios.set(this.lowestRiskTolerance,{weights:this.lowestRiskTolerancePortfolio,ret:this.getLowestReturn(),volatility:this.getLowestVolatility()})}}function $(r,n,o){this.efficientFrontier=null;try{this.efficientFrontier=new X(r,n,o),this.efficientFrontierOptimizationMethod="critical-line"}catch(t){if("internal error: impossible to solve the KKT system"!=t.message)throw t;this.efficientFrontier=new et(r,n,o),this.efficientFrontierOptimizationMethod="gsmo"}this.epsPortfolioVolatility=this.efficientFrontier.epsPortfolioVolatility,this.epsEfficientPortfolioComputation=this.efficientFrontier.epsEfficientPortfolioComputation,this.mu=this.efficientFrontier.mu,this.sigma=this.efficientFrontier.sigma,this.nbAssets=this.efficientFrontier.mu.nbRows,this.lowerBounds=this.efficientFrontier.lowerBounds,this.upperBounds=this.efficientFrontier.upperBounds}function h(t,r,n){void 0===n&&(n={constraints:{}}),void 0===n.constraints&&(n.constraints={}),this.epsBounds=1e-14,this.epsPortfolioVolatility=1e-14,this.epsEfficientPortfolioComputation=1e-10,this.mu=new it(t),this.sigma=new it(r),this.nbAssets=this.sigma.nbRows,this.lowerBounds=null==n.constraints.minWeights?it.zeros(this.nbAssets,1):new it(n.constraints.minWeights),this.upperBounds=null==n.constraints.maxWeights?it.ones(this.nbAssets,1):new it(n.constraints.maxWeights);for(var o=1;o<=this.nbAssets;++o){var i=this.lowerBounds.getValue(o,1),e=this.upperBounds.getValue(o,1);i==e&&(this.lowerBounds.setValueAt(o,1,Math.max(0,i-this.epsBounds)),this.upperBounds.setValueAt(o,1,Math.min(1,e+this.epsBounds)))}Y(this.nbAssets,this.lowerBounds.toArray(),this.upperBounds.toArray())}return y.randomCorrelationMatrix=function(t,r){return it.randomCorrelation(t,r)},y.nearestCorrelationMatrix=function(t,r){function n(t){if(!t.isSymmetric(a))throw new Error("internal error: input matrix must be symmetric");return t.unitDiagonalize()}function o(t,o){if(!t.isSymmetric(a))throw new Error("internal error: input matrix must be symmetric");var r=it.eig(t,{maxIter:-1,epsSymmetric:a}),n=r[0],i=r[1].elemMap(function(t,r,n){return Math.max(o,n)}),e=it.axty(1,it.elementwiseProduct(n,i.transpose()),n);return e=e.symmetrize({inPlace:!0})}t=new it(t);void 0===r&&(r={});var a=r.epsSymmetric;null==a&&(a=1e-12);var i=r.eps;null==i&&(i=1e-6);var e=r.maxIter;null==e&&(e=100);var s=r.minEigenvalue;if(null==s&&(s=1e-8),!t.isSymmetric(a))throw new Error("input matrix must be symmetric");for(var u=t.nbRows,l=it.copy(t),h=it.copy(t),f=it.zeros(u,u),m=Number.POSITIVE_INFINITY,c=Number.POSITIVE_INFINITY,d=Number.POSITIVE_INFINITY,w=0;;){if(-1!==e&&e<=w)throw new Error("maximum number of iterations reached: "+e);++w;var p=it.xmy(h,f),v=o(p,s),b=it.xmy(v,p),y=n(v);if(m=it.xmy(v,l).vectorNorm("infinity")/l.vectorNorm("infinity"),c=it.xmy(y,h).vectorNorm("infinity")/h.vectorNorm("infinity"),d=it.xmy(y,v).vectorNorm("infinity")/y.vectorNorm("infinity"),l=v,h=y,f=b,0==i){if(h.isCorrelationMatrix())break}else if(Math.max(m,c,d)<=i)break}if(0==i)return h;var g=l.diagonal().elemMap(function(t,r,n){return 1/Math.sqrt(n)});return it.elementwiseProduct(it.elementwiseProduct(l,g),g.transpose()).symmetrize({inPlace:!0}).unitDiagonalize({inPlace:!0})},y.repairCorrelationMatrix=function(t,r){void 0===r&&(r={});var n=r.method;void 0===n&&(n="nearest-correlation-matrix");var o=r.minEigenvalue;null==o&&(o=0);var i=r.epsNcm;null==i&&(i=1e-6);var e=r.epsCorrMat;null==e&&(e=1e-12);var a=r.shrinkageTarget;if("spectral"!=n&&"linear-shrinkage"!=n&&"nearest-correlation-matrix"!=n)throw new Error("unsupported correlation matrix repair method");if(!(t=new it(t)).isSymmetric(e))throw new Error("input matrix must be symmetric");if(!t.isUnitDiagonal(e))throw new Error("input matrix must be unit diagonal");if(o<0||1<o)throw new Error("lower bound on the smallest eigenvalue(s) of the correlation matrix must belong to interval [0,1]");var s,u=t.nbRows;if((d=it.eig(t,{maxIter:-1,epsSymmetric:e,sortedEigenvalues:!0}))[1].data[u-1]>=o)return t;if("spectral"==n){if(0<o)throw new Error("spectral correlation matrix repair is not compatible with a minimum eigenvalue");var l=d[0],h=d[1].elemMap(function(t,r,n){return Math.sqrt(Math.max(0,n))}),f=it.elementwiseProduct(l,h.transpose()),m=it.fill(u,1,function(t,r){return 1/f.vectorNorm("two","row",t)}),c=it.elementwiseProduct(f,m);s=(s=it.axty(1,c,c)).unitDiagonalize()}else if("linear-shrinkage"==n){if(null==a)a=it.identity(u);else{if(!(a=new it(a)).isCorrelationMatrix(e))throw new Error("shrinkage target matrix must be a correlation matrix");var d;if((d=it.eig(a,{maxIter:-1,epsSymmetric:e,sortedEigenvalues:!0}))[1].data[u-1]<o)throw new Error("smallest eigenvalue of the shrinkage target matrix strictly lower than the desired lower bound on the smallest eigenvalue(s) of the correlation matrix")}var w=t,p=a,v=q(function(t){var r=it.axpby(t,p,1-t,w);return it.eig(r,{maxIter:-1,epsSymmetric:e,sortedEigenvalues:!0})[1].data[u-1]-o},0,1,{outputInterval:!0})[1];s=(s=it.axpby(v,p,1-v,w)).symmetrize().unitDiagonalize()}else{if("nearest-correlation-matrix"!=n)throw new Error("internal error: unsupported repair method");s=y.nearestCorrelationMatrix(t,{maxIter:-1,eps:i,minEigenvalue:o})}return s},y.perturbedCorrelationMatrix=function(i,t){void 0===(t=t)&&(t={}),void 0===t.method&&(t.method="additive-noise");var r=t.epsCorrMat;null==r&&(r=1e-12);var n=t.epsNcm;null==n&&(n=1e-6);var o=t.sigma;null==o&&(o=.05);var e=t.noiseLevelMax;null==e&&(e=.01);var a=t.noiseSpaceDimension;null==a&&(a=3);var s=t.method;if("spectral-noise"!=s&&"multiplicative-noise"!=s&&"additive-noise"!=s)throw new Error("unsupported perturbation method");if(!(i=new it(i)).isCorrelationMatrix(r))throw new Error("input matrix must be symmetric, unit diagonal and positive semidefinite");var u,l=i.nbRows;if("spectral-noise"==s){var h=it.eig(i,{maxIter:-1,epsSymmetric:r,sortedEigenvalues:!0}),f=h[0],m=h[1].elemMap(function(t,r,n){return n*Math.exp(o*S(0,1))}),c=it.axty(1,it.elementwiseProduct(f,m.transpose()),f);u=(u=c.elemMap(function(t,r,n){return n/Math.sqrt(c.data[(t-1)*c.nbColumns+(t-1)]*c.data[(r-1)*c.nbColumns+(r-1)])})).symmetrize().unitDiagonalize()}else if("multiplicative-noise"==s)(u=it.fillSymmetric(l,function(t,r){return t==r?1:Math.max(-1,Math.min(1,i.data[(t-1)*i.nbColumns+(r-1)]*(1+o*S(0,1))))})).isCorrelationMatrix()||(u=y.nearestCorrelationMatrix(u,{maxIter:-1,eps:n}));else{if("additive-noise"!=s)throw new Error("internal error: unsupported perturbation method");for(var d=new V(a,!0),w=new Array(l),p=0;p<l;++p)w[p]=new it(d.sample());(u=it.fillSymmetric(l,function(t,r){if(t==r)return 1;var n=i.data[(t-1)*i.nbColumns+(r-1)],o=e*it.vectorDotProduct(w[t-1],w[r-1]);return Math.max(-1,Math.min(1,n+o))})).isCorrelationMatrix()||(u=y.nearestCorrelationMatrix(u,{maxIter:-1,eps:n}))}return u},y.covarianceMatrixFromCovarianceMatrix=function(t){return z(t=new it(t)),t},y.covarianceMatrixFromCorrelationMatrix=function(t,r,n){void 0===(n=n)&&(n={}),void 0===n.diagonalVectorType&&(n.diagonalVectorType="variances");var o=n.diagonalVectorType;if("variances"!=o&&"standard-deviations"!=o)throw new Error("unsupported diagonal vector type");t=new it(t),r=new it(r);if(t.nbRows!=r.nbRows||t.nbColumns!=r.nbRows)throw new Error("input correlation matrix dimensions not compatible with input diagonal vector dimension");var i;t.nbRows;if("variances"==o)i=r.elemMap(function(t,r,n){return Math.sqrt(n)});else{if("standard-deviations"!=o)throw new Error("internal error: unsupported diagonal vector type");i=r}var e=it.elementwiseProduct(it.elementwiseProduct(t,i),i.transpose());return z(e=e.symmetrize()),e},y.covarianceMatrix=function(i,t){void 0===(t=t)&&(t={}),void 0===t.method&&(t.method="covariance");var e=t.assumeZeroMean;null==e&&(e=!0);var r=t.regularizationMethod;if(null==r&&(r="none"),"none"!=r&&"linear-shrinkage"!=r)throw new Error("unsupported covariance matrix regularization method");var n=t.shrinkageTarget;if("linear-shrinkage"==r&&-1==["constant-variance-null-correlation","constant-variance-correlation","null-correlation","constant-correlation"].indexOf(n))throw new Error("unsupported covariance matrix shrinkage target");for(var o,a=i.length,s=i[0].length,u=0;u<a;++u)if(i[u].length!=s)throw new Error("inconsistent input matrix dimensions");if("none"==r){var l=F;0==e&&(l=O),o=k(a,a);for(u=0;u<o.nbRows;++u){for(var h=0;h<u;++h)o.data[u*o.nbColumns+h]=o.data[h*o.nbColumns+u];for(h=u;h<o.nbColumns;++h)o.data[u*o.nbColumns+h]=l(i[u],i[h])}}else{if("linear-shrinkage"!=r)throw new Error("internal error: unsupported covariance matrix regularization method");var f,m,c,d=it.fill(a,1,function(t,r){return I(i[t-1])}),w=it.fill(a,s,function(t,r){return i[t-1][r-1]-d.data[t-1]}),p=(f=1==e?it.axty(1/s,w,w).toCovarianceMatrix():it.axty(1/(s-1),w,w).toCovarianceMatrix()).getStandardDeviations(),v=f.getCorrelationMatrix();if("constant-variance-null-correlation"==n){var b=f.trace()/a;m=it.fill(a,a,function(t,r){return t==r?b:0})}else if("constant-variance-correlation"==n){var y=f.trace()/a,g=0;for(u=0;u<a-1;++u)for(h=u+1;h<a;++h)g+=f.data[u*f.nbColumns+h];g*=2/(a*(a-1)),m=it.fill(a,a,function(t,r){return t==r?y:g})}else if("null-correlation"==n)m=it.fill(a,a,function(t,r){return t==r?p.data[t-1]*p.data[t-1]:0});else if("constant-correlation"==n){for(u=c=0;u<a-1;++u)for(h=u+1;h<a;++h)c+=v.data[u*v.nbColumns+h];c*=2/(a*(a-1)),m=it.fill(a,a,function(t,r){return t==r?p.data[t-1]*p.data[t-1]:c*p.data[t-1]*p.data[r-1]})}var x,C=it.fill(a,a,function(t,r){for(var n=0,o=0;o<s;++o)n+=Math.pow((i[t-1][o]-d.data[t-1])*(i[r-1][o]-d.data[r-1])-f.data[(t-1)*f.nbColumns+(r-1)],2);return n/=1==e?s:s-1}),R=C.sum();if("constant-variance-null-correlation"==n)x=0;else if("constant-variance-correlation"==n)x=0;else if("null-correlation"==n)x=C.trace();else if("constant-correlation"==n){x=0;for(u=1;u<=a;++u)for(h=1;h<=a;++h)if(u!=h){for(var E=0,A=0;A<s;++A)E+=(Math.pow(i[u-1][A]-d.data[u-1],2)-f.data[(u-1)*f.nbColumns+(u-1)])*((i[u-1][A]-d.data[u-1])*(i[h-1][A]-d.data[h-1])-f.data[(u-1)*f.nbColumns+(h-1)]);E/=1==e?s:s-1;var M=0;for(A=0;A<s;++A)M+=(Math.pow(i[h-1][A]-d.data[h-1],2)-f.data[(h-1)*f.nbColumns+(h-1)])*((i[u-1][A]-d.data[u-1])*(i[h-1][A]-d.data[h-1])-f.data[(u-1)*f.nbColumns+(h-1)]);M/=1==e?s:s-1,x+=p.data[h-1]/p.data[u-1]*E+p.data[u-1]/p.data[h-1]*M}x*=c/2,x+=C.trace()}var P,_=(R-x)/Math.pow(it.xmy(f,m).matrixNorm("frobenius"),2);P=1==e?Math.max(0,Math.min(1,_/s)):Math.max(0,Math.min(1,_/(s-1))),o=it.axpby(P,m,1-P,f)}return z(o),o},(y.Matrix=it).prototype={constructor:it,toString:function(){for(var t=0,r=0;r<this.nbRows;++r)for(var n=0;n<this.nbColumns;++n){var o=String(this.data[r*this.nbColumns+n]).length;t<o&&(t=o)}var i=[];for(r=0;r<this.nbRows;++r){i.push("[ ");for(n=0;n<this.nbColumns;++n){var e=String(this.data[r*this.nbColumns+n]);i.push(new Array(t-e.length+1).join(" ")+e+" ")}i.push("]\n")}return i.join("")},toRowArray:function(t){t=t||function(t,r,n){return!0};for(var r=new Array(this.nbRows),n=0;n<this.nbRows;++n){r[n]=new Array(this.nbColumns);for(var o=0,i=0;i<this.nbColumns;++i){var e=this.data[n*this.nbColumns+i];t(n+1,i+1,e)&&(r[n][o++]=e)}r[n].length=o}return r},toArray:function(t){t=t||function(t,r,n){return!0};for(var r=new Array(this.nbRows*this.nbColumns),n=0,o=0;o<this.nbRows;++o)for(var i=0;i<this.nbColumns;++i){var e=this.data[o*this.nbColumns+i];t(o+1,i+1,e)&&(r[n++]=e)}return r.length=n,r},setValueAt:function(t,r,n){if(t<1||r<1||t>this.nbRows||r>this.nbColumns)throw new Error("index out of bounds when setting matrix value, ("+t+","+r+") in size ("+this.nbRows+","+this.nbColumns+")");return this.data[(t-1)*this.nbColumns+(r-1)]=n,this},setValue:function(t,r,n){return this.data[(t-1)*this.nbColumns+(r-1)]=n,this},getValueAt:function(t,r){if(t<1||r<1||t>this.nbRows||r>this.nbColumns)throw new Error("index out of bounds when getting matrix value, ("+t+","+r+") in size ("+this.nbRows+","+this.nbColumns+")");return this.data[(t-1)*this.nbColumns+(r-1)]},getValue:function(t,r){return this.data[(t-1)*this.nbColumns+(r-1)]},isSquare:function(){return this.nbRows===this.nbColumns},isSymmetric:function(t){if(null==t&&(t=0),!this.isSquare())return!1;for(var r=0;r<this.nbRows;++r)for(var n=0;n<this.nbColumns;++n)if(Math.abs(this.data[r*this.nbColumns+n]-this.data[n*this.nbColumns+r])>t)return!1;return!0},isUnitDiagonal:function(t){if(null==t&&(t=0),!this.isSquare())return!1;for(var r=this.data[0],n=0;n<this.nbRows;++n){var o=this.data[n*this.nbColumns+n];r<o&&(r=o)}return!(Math.abs(r-1)>t)},isCorrelationMatrix:function(t,r){if(null==t&&(t=0),null==r&&(r="boolean"),"exception"!=r&&"boolean"!=r)throw new Error("unexpected output type");try{if(!this.isSquare())throw"not square";if(!this.isSymmetric(t))throw"not symmetric";if(!this.isUnitDiagonal(t))throw"not unit diagonal";if(it.eig(this,{maxIter:-1,sortedEigenvalues:!0})[1].data[this.nbRows-1]<0)throw"not positive semi-definite";return!0}catch(t){if("exception"==r)throw new Error(t);return!1}},isCovarianceMatrix:function(t,r){if(null==t&&(t=0),null==r&&(r="boolean"),"exception"!=r&&"boolean"!=r)throw new Error("unexpected output type");try{if(!this.isSquare())throw"not square";if(!this.isSymmetric(t))throw"not symmetric";for(var n=this.data[0],o=0;o<this.nbRows;++o){var i=this.data[o*this.nbColumns+o];n<i&&(n=i)}if(n<-t)throw"not positive diagonal";if(it.eig(this,{maxIter:-1,sortedEigenvalues:!0})[1].data[this.nbRows-1]<0)throw"not positive semi-definite";return!0}catch(t){if("exception"==r)throw new Error(t);return!1}},isVector:function(){return 1===this.nbColumns},isNonNegative:function(){for(var t=0;t<this.nbRows;++t)for(var r=0;r<this.nbColumns;++r)if(this.data[t*this.nbColumns+r]<0)return!1;return!0},isPositive:function(){for(var t=0;t<this.nbRows;++t)for(var r=0;r<this.nbColumns;++r)if(this.data[t*this.nbColumns+r]<=0)return!1;return!0},isNonPositive:function(){for(var t=0;t<this.nbRows;++t)for(var r=0;r<this.nbColumns;++r)if(0<this.data[t*this.nbColumns+r])return!1;return!0},isNegative:function(){for(var t=0;t<this.nbRows;++t)for(var r=0;r<this.nbColumns;++r)if(0<=this.data[t*this.nbColumns+r])return!1;return!0},sum:function(){for(var t=0,r=0;r<this.data.length;++r)t+=this.data[r];return t},min:function(){for(var t=Number.POSITIVE_INFINITY,r=0;r<this.data.length;++r)this.data[r]<t&&(t=this.data[r]);return t},max:function(){for(var t=Number.NEGATIVE_INFINITY,r=0;r<this.data.length;++r)this.data[r]>t&&(t=this.data[r]);return t},normalize:function(t){var r=k(this.nbRows,this.nbColumns,t),n=this.sum();if(0===n)throw new Error("sum of coefficients of matrix is null");for(var o=0;o<this.data.length;++o)r.data[o]=this.data[o]/n;return r},diagonal:function(t){if(!this.isSquare())throw new Error("matrix is not square: ("+this.nbRows+","+this.nbColumns+")");for(var r=k(this.nbRows,1,t),n=0;n<this.nbRows;++n)r.data[n]=this.data[n*(this.nbColumns+1)];return r},row:function(t,r){if(t<1||t>this.nbRows)throw new Error("index out of bounds when getting matrix row, ("+t+") in size ("+this.nbRows+","+this.nbColumns+")");for(var n=k(this.nbColumns,1,r),o=0;o<this.nbColumns;++o)n.data[o]=this.data[(t-1)*this.nbColumns+o];return n},column:function(t,r){if(t<1||t>this.nbColumns)throw new Error("index out of bounds when getting matrix column, ("+t+") in size ("+this.nbRows+","+this.nbColumns+")");for(var n=k(this.nbRows,1,r),o=0;o<this.nbRows;++o)n.data[o]=this.data[o*this.nbColumns+(t-1)];return n},elemMap:function(t,r){for(var n=k(this.nbRows,this.nbColumns,r),o=0;o<n.nbRows;++o)for(var i=0;i<n.nbColumns;++i)n.data[o*n.nbColumns+i]=t(o+1,i+1,this.data[o*this.nbColumns+i]);return n},submatrix:function(t,r,n){if(!(t instanceof Array||t instanceof Uint32Array)||0==t.length)throw new Error("first parameter must be a non empty array");if(!(r instanceof Array||r instanceof Uint32Array)||0==r.length)throw new Error("second parameter must be a non empty array");for(var o=1;o<t.length;++o)if(t[o-1]>=t[o])throw new Error("first parameter must be a sorted array");for(var i=1;i<r.length;++i)if(r[i-1]>=t[i])throw new Error("second parameter must be a sorted array");var e=k(t.length,r.length,n);for(o=0;o<e.nbRows;++o){var a=t[o]-1;for(i=0;i<e.nbColumns;++i){var s=r[i]-1;e.data[o*e.nbColumns+i]=this.data[a*this.nbColumns+s]}}return e},transpose:function(t){for(var r=k(this.nbColumns,this.nbRows,t),n=0;n<r.nbRows;++n)for(var o=0;o<r.nbColumns;++o)r.data[n*r.nbColumns+o]=this.data[o*this.nbColumns+n];return r},determinant:function(){if(!this.isSquare())throw new Error("matrix is not square: ("+this.nbRows+","+this.nbColumns+")");for(var t=it.qrDecomposition(this,{qLess:!0}),r=1,n=0;n<t.data.length;n+=t.nbColumns+1)r*=t.data[n];return r},trace:function(){if(!this.isSquare())throw new Error("matrix is not square: ("+this.nbRows+","+this.nbColumns+")");for(var t=0,r=0;r<this.nbRows;++r)t+=this.data[r*this.nbColumns+r];return t},symmetrize:function(t){if(!this.isSquare())throw new Error("matrix is not square: ("+this.nbRows+","+this.nbColumns+")");var r;r=t&&t.inPlace?this:new it(this);for(var n=1;n<=r.nbRows;++n)for(var o=n+1;o<=r.nbColumns;++o){var i=(r.data[(n-1)*r.nbColumns+(o-1)]+r.data[(o-1)*r.nbColumns+(n-1)])/2;r.data[(n-1)*r.nbColumns+(o-1)]=i,r.data[(o-1)*r.nbColumns+(n-1)]=i}return r},unitDiagonalize:function(t){if(!this.isSquare())throw new Error("matrix is not square: ("+this.nbRows+","+this.nbColumns+")");var r;r=t&&t.inPlace?this:new it(this);for(var n=0;n<r.nbRows;++n)r.data[n*r.nbColumns+n]=1;return r},swapRows:function(t,r,n){if(!(1<=t&&t<=this.nbRows&&1<=r&&r<=this.nbRows))throw new Error("incorrect rows indexes: ("+t+","+r+")");var o;if(o=n&&n.inPlace?this:new it(this),t==r)return o;t-=1,r-=1;for(var i=0;i<o.nbColumns;++i){var e=o.data[t*o.nbColumns+i];o.data[t*o.nbColumns+i]=o.data[r*o.nbColumns+i],o.data[r*o.nbColumns+i]=e}return o},swapColumns:function(t,r,n){if(!(1<=t&&t<=this.nbColumns&&1<=r&&r<=this.nbColumns))throw new Error("incorrect columns indexes: ("+t+","+r+")");var o;if(o=n&&n.inPlace?this:new it(this),t==r)return o;t-=1,r-=1;for(var i=0;i<o.nbRows;++i){var e=o.data[i*o.nbColumns+t];o.data[i*o.nbColumns+t]=o.data[i*o.nbColumns+r],o.data[i*o.nbColumns+r]=e}return o},matrixNorm:function(t){if("one"==t){for(var r=0,n=0;n<this.nbColumns;++n){for(var o=0,i=0;i<this.nbRows;++i)o+=Math.abs(this.data[i*this.nbColumns+n]);r=Math.max(r,o)}return r}if("infinity"==t){var e=0;for(i=0;i<this.nbRows;++i){var a=0;for(n=0;n<this.nbColumns;++n)a+=Math.abs(this.data[i*this.nbColumns+n]);e=Math.max(e,a)}return e}if("frobenius"==t)return this.vectorNorm("two");throw new Error("unsupported matrix norm: "+t)},vectorNorm:function(t,r,n){var o,i,e,a;if(void 0===r||"matrix"==r)o=0,i=this.nbRows,e=0,a=this.nbColumns;else if("row"==r){if(void 0===n)throw new Error("undefined row index");if(n<1||n>this.nbRows)throw new Error("row index out of bounds: "+n);o=n-1,i=n,e=0,a=this.nbColumns}else if("column"==r){if(void 0===n)throw new Error("undefined row index");if(n<1||n>this.nbColumns)throw new Error("column index out of bounds: "+n);o=0,i=this.nbRows,e=n-1,a=n}else if(void 0!==r)throw new Error("unsupported matrix subset: "+r);if("one"==t){for(var s=0,u=o*this.nbColumns,l=o;l<i;++l){for(var h=u+e,f=e;f<a;++f)s+=Math.abs(this.data[h]),h++;u+=this.nbColumns}return s}if("two"==t){var m=0,c=1;for(u=o*this.nbColumns,l=o;l<i;++l){for(h=u+e,f=e;f<a;++f){var d=this.data[h],w=Math.abs(d);0!=w&&(m<w?(c=1+c*(m/d)*(m/d),m=w):c+=d/m*(d/m)),h++}u+=this.nbColumns}return m*Math.sqrt(c)}if("infinity"!=t)throw new Error("unsupported vector norm: "+t);var p=0;for(u=o*this.nbColumns,l=o;l<i;++l){for(h=u+e,f=e;f<a;++f)p=Math.max(p,Math.abs(this.data[h])),h++;u+=this.nbColumns}return p},toCovarianceMatrix:function(){return z(this),this}},it.areEqual=function(t,r,n){if(!(t instanceof it))throw new Error("a must be a matrix");if(!(r instanceof it))throw new Error("b must be a matrix");if(t.nbRows!==r.nbRows)return!1;if(t.nbColumns!==r.nbColumns)return!1;for(var o=t.nbRows*t.nbColumns,i=n||0,e=0;e<o;++e)if(Math.abs(t.data[e]-r.data[e])>i)return!1;return!0},it.xpy=function(t,r,n){if(!(t instanceof it))throw new Error("first input must be a matrix");if(!(r instanceof it))throw new Error("second input must be a matrix");if(t.nbColumns!==r.nbColumns||t.nbRows!==r.nbRows)throw new Error("input matrices sizes do not match: ("+t.nbRows+","+t.nbColumns+") - ("+r.nbRows+","+r.nbColumns+")");for(var o=k(t.nbRows,t.nbColumns,n),i=t.nbRows*t.nbColumns,e=0;e<i;++e)o.data[e]=t.data[e]+r.data[e];return o},it.xmy=function(t,r,n){if(!(t instanceof it))throw new Error("first input must be a matrix");if(!(r instanceof it))throw new Error("second input must be a matrix");if(t.nbColumns!==r.nbColumns||t.nbRows!==r.nbRows)throw new Error("input matrices sizes do not match: ("+t.nbRows+","+t.nbColumns+") - ("+r.nbRows+","+r.nbColumns+")");for(var o=k(t.nbRows,t.nbColumns,n),i=t.nbRows*t.nbColumns,e=0;e<i;++e)o.data[e]=t.data[e]-r.data[e];return o},it.axpby=function(t,r,n,o,i){if(!(r instanceof it))throw new Error("first input must be a matrix");if(!(o instanceof it))throw new Error("second input must be a matrix");if(r.nbColumns!==o.nbColumns||r.nbRows!==o.nbRows)throw new Error("input matrices sizes do not match: ("+r.nbRows+","+r.nbColumns+") - ("+o.nbRows+","+o.nbColumns+")");for(var e=k(r.nbRows,r.nbColumns,i),a=r.nbRows*r.nbColumns,s=0;s<a;++s)e.data[s]=t*r.data[s]+n*o.data[s];return e},it.copy=function(t,r){if(!(t instanceof it))throw new Error("first input must be a matrix");for(var n=k(t.nbRows,t.nbColumns,r),o=t.nbRows*t.nbColumns,i=0;i<o;++i)n.data[i]=t.data[i];return n},it.elementwiseProduct=function(t,r,n){if(!(t instanceof it))throw new Error("first input must be a matrix");if(!(r instanceof it))throw new Error("second input must be a matrix");if(!(t.nbRows===r.nbRows&&t.nbColumns===r.nbColumns||r.nbRows===t.nbRows&&1===r.nbColumns||1===r.nbRows&&r.nbColumns===t.nbColumns))throw new Error("input matrices sizes do not match: ("+t.nbRows+","+t.nbColumns+") - ("+r.nbRows+","+r.nbColumns+")");var o=k(t.nbRows,t.nbColumns,n),i=t.nbRows,e=t.nbColumns;if(t.nbRows===r.nbRows&&t.nbColumns===r.nbColumns)for(var a=i*e,s=0;s<a;++s)o.data[s]=t.data[s]*r.data[s];else if(r.nbRows===t.nbRows&&1===r.nbColumns)for(var u=0,l=0;l<i;++l)for(var h=r.data[l],f=0;f<e;++f)o.data[u]=t.data[u]*h,u++;else if(1===r.nbRows&&r.nbColumns===t.nbColumns)for(u=0,l=0;l<i;++l)for(f=0;f<e;++f)o.data[u]=t.data[u]*r.data[f],u++;return o},it.xy=function(t,r,n){if(!(t instanceof it))throw new Error("first input must be a matrix");if(!(r instanceof it))throw new Error("second input must be a matrix");if(t.nbColumns!==r.nbRows)throw new Error("matrices sizes do not match: ("+t.nbRows+","+r.nbColumns+") - ("+r.nbRows+","+r.nbColumns+")");for(var o=k(t.nbRows,r.nbColumns,n),i=t.nbRows,e=t.nbColumns,a=r.nbColumns,s=0,u=0,l=0;l<i;++l){for(var h=u,f=0;f<a;++f)o.data[h]=0,h++;for(var m=0,c=0;c<e;++c){var d=t.data[s];h=u;for(f=0;f<a;++f)o.data[h]+=d*r.data[m],m++,h++;s++}u+=a}return o},it.txy=function(t,r,n){if(!(t instanceof it))throw new Error("second input must be a matrix");if(!(r instanceof it))throw new Error("third input must be a matrix");if(t.nbRows!==r.nbRows)throw new Error("matrices sizes do not match: ("+t.nbRows+","+r.nbColumns+") - ("+r.nbRows+","+r.nbColumns+")");for(var o=k(t.nbColumns,r.nbColumns,n),i=t.nbColumns,e=t.nbRows,a=r.nbColumns,s=0,u=0,l=0,h=0;h<i;++h){for(var f=t.data[s],m=d,c=0;c<a;++c)o.data[u]=f*r.data[c],u++;s++}var d=a;for(l=1;l<e;++l){for(h=u=0;h<i;++h){for(f=t.data[s],m=d,c=0;c<a;++c)o.data[u]+=f*r.data[m],u++,m++;s++}d+=a}return o},it.axy=function(t,r,n,o){if(!(r instanceof it))throw new Error("second input must be a matrix");if(!(n instanceof it))throw new Error("third input must be a matrix");if(r.nbColumns!==n.nbRows)throw new Error("matrices sizes do not match: ("+r.nbRows+","+n.nbColumns+") - ("+n.nbRows+","+n.nbColumns+")");for(var i=k(r.nbRows,n.nbColumns,o),e=r.nbRows,a=r.nbColumns,s=n.nbColumns,u=0,l=0,h=0;h<e;++h){for(var f=l,m=0;m<s;++m)i.data[f]=0,f++;for(var c=0,d=0;d<a;++d){var w=t*r.data[u];f=l;for(m=0;m<s;++m)i.data[f]+=w*n.data[c],c++,f++;u++}l+=s}return i},it.ax=function(t,r,n){if(!(r instanceof it))throw new Error("second input must be a matrix");for(var o=k(r.nbRows,r.nbColumns,n),i=r.nbRows,e=r.nbColumns,a=1;a<=i;++a)for(var s=1;s<=e;++s)o.setValue(a,s,t*r.getValue(a,s));return o},it.axty=function(t,r,n,o){if(!(r instanceof it))throw new Error("second input must be a matrix");if(!(n instanceof it))throw new Error("third input must be a matrix");if(r.nbColumns!==n.nbColumns)throw new Error("matrices sizes do not match: ("+r.nbRows+","+n.nbColumns+") - ("+n.nbRows+","+n.nbColumns+")");for(var i=k(r.nbRows,n.nbRows,o),e=0;e<r.nbRows;++e)for(var a=0;a<n.nbRows;++a){for(var s=i.data[e*i.nbColumns+a]=0;s<r.nbColumns;++s)i.data[e*i.nbColumns+a]+=r.data[e*r.nbColumns+s]*n.data[a*n.nbColumns+s];i.data[e*i.nbColumns+a]=t*i.data[e*i.nbColumns+a]}return i},it.atxy=function(t,r,n,o){if(!(r instanceof it))throw new Error("second input must be a matrix");if(!(n instanceof it))throw new Error("third input must be a matrix");if(r.nbRows!==n.nbRows)throw new Error("matrices sizes do not match: ("+r.nbRows+","+n.nbColumns+") - ("+n.nbRows+","+n.nbColumns+")");for(var i=k(r.nbColumns,n.nbColumns,o),e=0,a=0;a<r.nbColumns;++a){for(var s=t*r.data[e*r.nbColumns+a],u=0;u<n.nbColumns;++u)i.data[a*i.nbColumns+u]=0;for(u=0;u<n.nbColumns;++u)i.data[a*i.nbColumns+u]+=s*n.data[e*n.nbColumns+u]}for(e=1;e<r.nbRows;++e)for(a=0;a<r.nbColumns;++a)for(s=t*r.data[e*r.nbColumns+a],u=0;u<n.nbColumns;++u)i.data[a*i.nbColumns+u]+=s*n.data[e*n.nbColumns+u];return i},it.diagonal=function(t,r){if(!(t instanceof it&&t.isVector()))throw new Error("first input must be a vector");for(var n=t.nbRows,o=k(n,n,r),i=0;i<n;++i){for(var e=0;e<n;++e)o.data[i*n+e]=0;o.data[i*n+i]=t.data[i]}return o},it.fillSymmetric=function(t,r,n){if(t<1)throw new Error("input number of rows and columns out of bounds: "+t);for(var o=k(t,t,n),i=0;i<t;++i){for(var e=0;e<i;++e)o.data[i*t+e]=o.data[e*t+i];for(e=i;e<o.nbColumns;++e)o.data[i*t+e]=r(i+1,e+1)}return o},it.fill=function(t,r,n,o){if(t<1)throw new Error("input number of rows out of bounds: "+t);if(r<1)throw new Error("input number of columns out of bounds: "+r);for(var i=k(t,r,o),e=0;e<t;++e)for(var a=0;a<r;++a)i.data[e*r+a]=n(e+1,a+1);return i},it.zeros=function(t,r,n){for(var o=k(t,r,n),i=t*r,e=0;e<i;++e)o.data[e]=0;return o},it.ones=function(t,r){for(var n=k(t,r),o=t*r,i=0;i<o;++i)n.data[i]=1;return n},it.identity=function(t){for(var r=k(t,t),n=t*t,o=0;o<n;++o)o%(t+1)==(r.data[o]=0)&&(r.data[o]=1);return r},it.normrnd=function(t,r,n,o){for(var i=k(t,r),e=t*r,a=0;a<e;++a)i.data[a]=S(n,o);return i},it.vectorHadamardProduct=function(t,r){return it.elementwiseProduct(t,r)},it.vectorDotProduct=function(t,r){if(!t.isVector())throw new Error("first argument must be a vector");if(!r.isVector())throw new Error("second argument must be a vector");if(t.nbRows!==r.nbRows)throw new Error("Vectors sizes do not match: ("+t.nbRows+") - ("+r.nbRows+")");for(var n=0,o=t.nbRows,i=0;i<o;++i)n+=t.data[i]*r.data[i];return n},it.choleskyDecomposition=function(t,r){void 0===r&&(r={});var n=r.epsSymmetric;null==n&&(n=0);var o=r.epsSdp;null==o&&(o=1e-16*t.nbRows);var i=r.pivoting;if(null==i&&(i="none"),"none"!=i&&"complete"!=i)throw new Error("unknown pivoting");var e=r.permutationOutputForm;if(null==e&&(e="matrix"),"vector"!=e&&"matrix"!=e)throw new Error("unknown permutation output form value");if(!(t instanceof it))throw new Error("input must be a matrix");if(!t.isSymmetric(n))throw new Error("input matrix must be symmetric");var a=t.nbRows;if("none"==i)for(var s=it.zeros(a,a),u=it.zeros(a,1),l=1;l<=a;++l){for(var h=l;h<=a;++h)u.data[h-1]=t.data[(h-1)*t.nbColumns+(l-1)];for(var f=1;f<=l-1;++f)for(h=l;h<=a;++h)u.data[h-1]-=s.data[(l-1)*s.nbColumns+(f-1)]*s.data[(h-1)*s.nbColumns+(f-1)];if(u.data[l-1]<=0)throw new Error("input matrix must be positive definite");for(h=l;h<=a;++h)s.data[(h-1)*s.nbColumns+(l-1)]=u.data[h-1]/Math.sqrt(u.data[l-1])}else{if("complete"!=i)throw new Error("internal error: unknown pivoting");u=it.zeros(a,1);var m,c=new it(t),d=it.fill(a,1,function(t,r){return t});for(f=1;f<=a;++f){l=-1;var w=Number.NEGATIVE_INFINITY;for(h=f;h<=a;++h){var p=c.data[(h-1)*c.nbColumns+(h-1)];w<p&&(l=h,w=p)}if(1==f&&(m=w),Math.abs(w)<=m*o)break;if(w<m*o)throw new Error("input matrix must be semi-definite positive");d.swapRows(f,l,{inPlace:!0}),c.swapRows(f,l,{inPlace:!0}),c.swapColumns(f,l,{inPlace:!0});for(h=f+1;h<=a;++h)u.data[h-1]=c.data[(h-1)*c.nbColumns+(f-1)];if(0==w)throw new Error("internal error: null pivot detected");for(h=f+1;h<=a;++h)c.data[(h-1)*c.nbColumns+(f-1)]/=w;for(h=f+1;h<=a;++h)for(l=f+1;l<=a;++l)c.data[(h-1)*c.nbColumns+(l-1)]-=u.data[h-1]*u.data[l-1]/w}}if("none"==i)return{lowerTriangular:s};if("complete"!=i)throw new Error("internal error: unknown pivoting");var v,b=it.fill(a,1,function(t,r){return Math.max(0,c.data[(t-1)*c.nbColumns+(t-1)])}),y=it.fill(a,a,function(t,r){return t==r?1:r<t?c.data[(t-1)*c.nbColumns+(r-1)]:0});if("vector"==e)v=d;else{if("matrix"!=e)throw new Error("internal error: unknown permutation output form value");v=it.fill(a,a,function(t,r){return t==d.data[r-1]?1:0})}return{lowerTriangular:y,diagonal:b,permutation:v}},it.luDecomposition=function(t,r){void 0===r&&(r={});var n=r.permutationsOutputForm;if(null==n&&(n="matrix"),"vector"!=n&&"matrix"!=n)throw new Error("unknown permutation output form value");if(!(t instanceof it))throw new Error("input must be a matrix");if(!t.isSquare())throw new Error("input must be square");for(var o=t.nbRows,i=it.fill(o,1,function(t,r){return t}),e=it.fill(o,1,function(t,r){return t}),a=new it(t),s=1;s<=o-1;++s){for(var u=-1,l=-1,h=-1,f=s;f<=o;++f)for(var m=s;m<=o;++m){var c=Math.abs(a.data[(f-1)*a.nbColumns+(m-1)]);h<c&&(u=f,l=m,h=c)}i.swapRows(s,u,{inPlace:!0}),a.swapRows(s,u,{inPlace:!0}),e.swapRows(s,l,{inPlace:!0}),a.swapColumns(s,l,{inPlace:!0});var d=a.data[(s-1)*a.nbColumns+(s-1)];if(0!=d)for(f=s+1;f<=o;++f){a.data[(f-1)*a.nbColumns+(s-1)]/=d;for(m=s+1;m<=o;++m)a.data[(f-1)*a.nbColumns+(m-1)]-=a.data[(f-1)*a.nbColumns+(s-1)]*a.data[(s-1)*a.nbColumns+(m-1)]}}var w,p,v=it.fill(o,o,function(t,r){return r<t?a.data[(t-1)*a.nbColumns+(r-1)]:t==r?1:0}),b=it.fill(o,o,function(t,r){return t<=r?a.data[(t-1)*a.nbColumns+(r-1)]:0});if("vector"==n)w=i,p=e;else{if("matrix"!=n)throw new Error("internal error: unknown permutation output form value");w=it.fill(o,o,function(t,r){return r==i.data[t-1]?1:0}),p=it.fill(o,o,function(t,r){return t==e.data[r-1]?1:0})}return{lowerTriangular:v,upperTriangular:b,rowPermutation:w,columnPermutation:p}},it.qrDecomposition=function(t,r){function n(t,r){var n,o,i;if(0==r)n=0<=t?1:-1,o=0,i=Math.abs(t);else if(0==t)o=(n=0)<=r?1:-1,i=Math.abs(r);else if(Math.abs(t)>Math.abs(r)){o=(e=r/t)*(n=1/(a=(0<=t?1:-1)*Math.sqrt(1+e*e))),i=t*a}else{var e,a;n=(e=t/r)*(o=1/(a=(0<=r?1:-1)*Math.sqrt(1+e*e))),i=r*a}return[n,-o,i]}void 0===r&&(r={});var o=r.qLess||!1;if(!(t instanceof it))throw new Error("first input must be a matrix");if(t.nbRows<t.nbColumns)throw new Error("matrix has more columns than rows: ("+t.nbRows+") v.s. ("+t.nbColumns+")");var i=t.nbRows,e=t.nbColumns,a=new it(t),s=null;o||(s=it.identity(i));for(var u=1;u<=e;++u)for(var l=i;u+1<=l;--l){var h=(l-2)*a.nbColumns+(u-1),f=(l-1)*a.nbColumns+(u-1),m=n(a.data[h],a.data[f]),c=m[0],d=m[1],w=m[2];a.data[h]=w,a.data[f]=0;for(var p=u+1;p<=e;++p){var v=(l-2)*a.nbColumns+(p-1),b=(l-1)*a.nbColumns+(p-1),y=a.data[v],g=a.data[b];a.data[v]=c*y-d*g,a.data[b]=d*y+c*g}if(!o)for(p=1;p<=i;++p){var x=(p-1)*s.nbColumns+(l-2),C=(p-1)*s.nbColumns+(l-1);y=s.data[x],g=s.data[C];s.data[x]=c*y-d*g,s.data[C]=d*y+c*g}}return o?a:[s,a]},it.svdDecomposition=function(t,r){void 0===r&&(r={});var n=r.eps||1e-16,o=r.maxIter||100,i=r.svdForm||"thin";if(!(t instanceof it))throw new Error("first input must be a matrix");if(t.nbRows<t.nbColumns)throw new Error("matrix has more columns than rows: "+t.nbColumns+" v.s. "+t.nbRows);for(var e=t.nbRows,a=t.nbColumns,s=new it(t),u=s.matrixNorm("frobenius"),l=it.identity(a),h=0,f="function"==typeof Float64Array?new Float64Array(a):new Array(a);;){if(++h,-1!==o&&o<h)throw new Error("maximum number of iterations reached: "+o);for(var m=1;m<=a;++m){var c=s.vectorNorm("two","column",m);f[m-1]=c*c}var d=!0;for(m=2;m<=a;++m)for(var w=1;w<=m-1;++w){for(var p=f[w-1],v=f[m-1],b=0,y=1;y<=e;++y)b+=s.data[(y-1)*s.nbColumns+(w-1)]*s.data[(y-1)*s.nbColumns+(m-1)];if(!(Math.abs(b)<=n*Math.sqrt(e*p*v))&&!(Math.sqrt(p)<=n*u||Math.sqrt(v)<=n*u)){d=!1;var g=(p-v)/(2*b),x=(0<=g?1:-1)/(Math.abs(g)+Math.sqrt(1+g*g)),C=1/Math.sqrt(1+x*x),R=C*x;for(y=1;y<=e;++y){var E=s.data[(y-1)*s.nbColumns+(w-1)],A=s.data[(y-1)*s.nbColumns+(m-1)];s.data[(y-1)*s.nbColumns+(w-1)]=C*E+R*A,s.data[(y-1)*s.nbColumns+(m-1)]=-R*E+C*A}f[w-1]+=x*b,f[m-1]-=x*b;for(y=1;y<=a;++y){E=l.data[(y-1)*l.nbColumns+(w-1)],A=l.data[(y-1)*l.nbColumns+(m-1)];l.data[(y-1)*l.nbColumns+(w-1)]=C*E+R*A,l.data[(y-1)*l.nbColumns+(m-1)]=-R*E+C*A}}}if(1==d)break}var M="function"==typeof Float64Array?new Float64Array(a):new Array(a),P="function"==typeof Uint32Array?new Uint32Array(a):new Array(a);for(m=1;m<=a;++m){var _=Math.sqrt(f[m-1]);M[m-1]=_,P[m-1]=m}P.sort(function(t,r){return M[r-1]-M[t-1]});var z=it.zeros(e,a),k=it.zeros(a,a),I=it.zeros(a,a);for(m=1;m<=a;++m){var S=P[m-1],F=M[S-1];if(0!=(k.data[(m-1)*k.nbColumns+(m-1)]=F))for(w=1;w<=e;++w)z.data[(w-1)*z.nbColumns+(m-1)]=s.data[(w-1)*s.nbColumns+(S-1)]/F;for(w=1;w<=a;++w)I.data[(w-1)*I.nbColumns+(m-1)]=l.data[(w-1)*l.nbColumns+(S-1)]}if("thin"==i)return[z,k,I];var V=it.qrDecomposition(z)[0],O=it.zeros(e,e),T=it.zeros(e,a);for(m=1;m<=a;++m){S=P[m-1],F=M[S-1];if(0!=(T.data[(m-1)*T.nbColumns+(m-1)]=F))for(w=1;w<=e;++w)O.data[(w-1)*O.nbColumns+(m-1)]=z.data[(w-1)*z.nbColumns+(m-1)];else for(w=1;w<=e;++w)O.data[(w-1)*O.nbColumns+(m-1)]=V.data[(w-1)*V.nbColumns+(m-1)]}for(m=a+1;m<=e;++m)for(w=1;w<=e;++w)O.data[(w-1)*O.nbColumns+(m-1)]=V.data[(w-1)*V.nbColumns+(m-1)];return"full"==i?[O,T,I]:void 0},it.eig=function(t,r){void 0===r&&(r={});var n=r.epsSymmetric;null==n&&(n=0);var o=r.maxIter;null==o&&(o=100);var i=r.sortedEigenvalues;if(null==i&&(i=!1),!(t instanceof it))throw new Error("input must be a matrix");if(!t.isSymmetric(n))throw new Error("input matrix must be symmetric");for(var e=t.nbRows,a=new it(t),s=it.identity(e),u=a.diagonal(),l=new it(u),h=it.zeros(e,1),f=0;;){if(++f,-1!==o&&o<f)throw new Error("maximum number of iterations reached: "+o);for(var m=0,c=1;c<=e-1;++c)for(var d=c+1;d<=e;++d)m+=Math.abs(a.data[(c-1)*a.nbColumns+(d-1)]);if(0==m)break;var w=f<4?.2*m/(e*e):0;for(c=1;c<=e-1;++c)for(d=c+1;d<=e;++d){var p=100*Math.abs(a.data[(c-1)*a.nbColumns+(d-1)]);if(4<f&&Math.abs(u.data[c-1])+p==Math.abs(u.data[c-1])&&Math.abs(u.data[d-1])+p==Math.abs(u.data[d-1]))a.data[(c-1)*a.nbColumns+(d-1)]=0;else if(Math.abs(a.data[(c-1)*a.nbColumns+(d-1)])>w){var v,b=u.data[d-1]-u.data[c-1];if(Math.abs(b)+p==Math.abs(b))v=a.data[(c-1)*a.nbColumns+(d-1)]/b;else{var y=.5*b/a.data[(c-1)*a.nbColumns+(d-1)];v=1/(Math.abs(y)+Math.sqrt(1+y*y)),y<0&&(v=-v)}var g=1/Math.sqrt(1+v*v),x=v*g,C=x/(1+g);b=v*a.data[(c-1)*a.nbColumns+(d-1)];for(h.data[c-1]-=b,h.data[d-1]+=b,u.data[c-1]-=b,u.data[d-1]+=b,a.data[(c-1)*a.nbColumns+(d-1)]=0,R=1;R<=c-1;++R){p=a.data[(R-1)*a.nbColumns+(c-1)],b=a.data[(R-1)*a.nbColumns+(d-1)];a.data[(R-1)*a.nbColumns+(c-1)]=p-x*(b+p*C),a.data[(R-1)*a.nbColumns+(d-1)]=b+x*(p-b*C)}for(R=c+1;R<=d-1;++R){p=a.data[(c-1)*a.nbColumns+(R-1)],b=a.data[(R-1)*a.nbColumns+(d-1)];a.data[(c-1)*a.nbColumns+(R-1)]=p-x*(b+p*C),a.data[(R-1)*a.nbColumns+(d-1)]=b+x*(p-b*C)}for(R=d+1;R<=e;++R){p=a.data[(c-1)*a.nbColumns+(R-1)],b=a.data[(d-1)*a.nbColumns+(R-1)];a.data[(c-1)*a.nbColumns+(R-1)]=p-x*(b+p*C),a.data[(d-1)*a.nbColumns+(R-1)]=b+x*(p-b*C)}for(var R=1;R<=e;++R){p=s.data[(R-1)*s.nbColumns+(c-1)],b=s.data[(R-1)*s.nbColumns+(d-1)];s.data[(R-1)*s.nbColumns+(c-1)]=p-x*(b+p*C),s.data[(R-1)*s.nbColumns+(d-1)]=b+x*(p-b*C)}}}for(c=1;c<=e;++c)l.data[c-1]+=h.data[c-1],u.data[c-1]=l.data[c-1],h.data[c-1]=0}var E=u,A=s;if(i){for(var M="function"==typeof Uint32Array?new Uint32Array(e):new Array(e),P=1;P<=e;++P)M[P-1]=P;M.sort(function(t,r){return u.data[r-1]-u.data[t-1]}),E=it.zeros(e,1),A=it.zeros(e,e);for(P=1;P<=e;++P){var _=M[P-1];E.data[P-1]=u.data[_-1];for(R=1;R<=e;++R)A.data[(R-1)*A.nbColumns+(P-1)]=s.data[(R-1)*s.nbColumns+(_-1)]}}return[A,E]},it.nullSpace=function(t,r){void 0===r&&(r={});var n=r.eps||void 0;if(!(t instanceof it))throw new Error("first input must be a matrix");var o=t.nbRows,i=t.nbColumns,e=null;if(i<=o){var a=(f=it.svdDecomposition(t,{maxIter:-1}))[0],s=f[1],u=f[2];for(void 0===n&&(n=o*(p(s.data[0])-s.data[0])),m=i;1<=m&&!(s.data[(m-1)*s.nbColumns+(m-1)]>n);--m);if((c=m)==i)e=it.zeros(i,1);else{e=new it.zeros(i,i-c);for(var l=c+1;l<=i;++l)for(var h=1;h<=i;++h)e.data[(h-1)*e.nbColumns+(l-(c+1)+1-1)]=u.data[(h-1)*u.nbColumns+(l-1)]}}else{var f,m,c;a=(f=it.svdDecomposition(t.transpose(),{maxIter:-1,svdForm:"full"}))[0],s=f[1],u=f[2];for(void 0===n&&(n=i*(p(s.data[0])-s.data[0])),m=o;1<=m&&!(s.data[(m-1)*s.nbColumns+(m-1)]>n);--m);if((c=m)==o)e=it.zeros(i,1);else{var d=new it.zeros(i,c);for(l=1;l<=c;++l)for(h=1;h<=i;++h)d.data[(h-1)*d.nbColumns+(l-1)]=a.data[(h-1)*a.nbColumns+(l-1)];var w=it.qrDecomposition(d)[0];for(e=new it.zeros(i,i-c),l=c+1;l<=i;++l)for(h=1;h<=i;++h)e.data[(h-1)*e.nbColumns+(l-(c+1)+1-1)]=w.data[(h-1)*w.nbColumns+(l-1)]}}return e},it.linsolveBackSubstitution=function(t,r){if(!(t instanceof it))throw new Error("first input must be a matrix");if(!(r instanceof it))throw new Error("second input must be a matrix");if(!t.isSquare())throw new Error("matrix is not square: ("+t.nbRows+","+t.nbColumns+")");if(t.nbRows!==r.nbRows)throw new Error("matrix and second member sizes do not match: ("+t.nbRows+","+t.nbColumns+") - ("+r.nbRows+","+r.nbColumns+")");if(1!==r.nbColumns)throw new Error("b is not a vector: ("+r.nbRows+","+r.nbColumns+")");for(var n=t.nbColumns,o=new it(r),i=n;1<=i;--i){var e=t.data[(i-1)*t.nbColumns+(i-1)];if(0==e)throw new Error("input matrix is not invertible: zero diagonal coefficient at index "+i);for(var a=i+1;a<=n;++a)o.data[i-1]-=t.data[(i-1)*t.nbColumns+(a-1)]*o.data[a-1];o.data[i-1]/=e}return o},it.linsolveForwardSubstitution=function(t,r){if(!(t instanceof it))throw new Error("first input must be a matrix");if(!(r instanceof it))throw new Error("second input must be a matrix");if(!t.isSquare())throw new Error("matrix is not square: ("+t.nbRows+","+t.nbColumns+")");if(t.nbRows!==r.nbRows)throw new Error("matrix and second member sizes do not match: ("+t.nbRows+","+t.nbColumns+") - ("+r.nbRows+","+r.nbColumns+")");if(1!==r.nbColumns)throw new Error("b is not a vector: ("+r.nbRows+","+r.nbColumns+")");for(var n=t.nbColumns,o=new it(r),i=1;i<=n;++i){var e=t.data[(i-1)*t.nbColumns+(i-1)];if(0==e)throw new Error("input matrix is not invertible: zero diagonal coefficient at index "+i);for(var a=1;a<=i-1;++a)o.data[i-1]-=t.data[(i-1)*t.nbColumns+(a-1)]*o.data[a-1];o.data[i-1]/=e}return o},it.randomOrthogonal=function(t){var r=it.normrnd(t,t),n=it.qrDecomposition(r),o=n[0],i=n[1],e=it.fill(1,t,function(t,r){return 0<=i.data[(r-1)*i.nbColumns+(r-1)]?1:-1});return it.elementwiseProduct(o,e)},it.randomCorrelation=function(t,n){if(void 0===n&&(n={}),void 0===n.eps&&(n.eps=1e-14),void 0===n.epsLambda&&(n.epsLambda=1e-8),void 0===n.lambda){n.lambda=new Q(t).sample();for(var r=0;r<t;++r)n.lambda[r]*=t}if(n.lambda.length!=t)throw new Error("number of input eigenvalues not equal to "+t+", but to "+n.lambda.length);var o=0;for(r=0;r<t;++r)o+=n.lambda[r];if(Math.abs(o-t)>n.epsLambda)throw new Error("input eigenvalues not summing to "+t);for(var i=n.eps,e=it.fill(1,t,function(t,r){return n.lambda[r-1]}),a=it.randomOrthogonal(t),s=it.axty(1,it.elementwiseProduct(a,e),a),u=1;u<t;++u){for(var l=!0,h=1;h<=t;++h){var f=s.data[(h-1)*s.nbColumns+(h-1)];if(Math.abs(f-1)>i){l=!1;break}1!=f&&(s.data[(h-1)*s.nbColumns+(h-1)]=1)}if(l)break;r=-1;var m=-1;for(h=1;h<=t;++h)s.data[(h-1)*s.nbColumns+(h-1)]<1&&-1===r&&(r=h),1<s.data[(h-1)*s.nbColumns+(h-1)]&&(m=h);if(m<r){m=r=-1;for(h=1;h<=t;++h)1<s.data[(h-1)*s.nbColumns+(h-1)]&&-1===r&&(r=h),s.data[(h-1)*s.nbColumns+(h-1)]<1&&(m=h)}var c=s.data[(r-1)*s.nbColumns+(r-1)],d=s.data[(r-1)*s.nbColumns+(m-1)],w=s.data[(m-1)*s.nbColumns+(m-1)],p=(d+Math.sqrt(d*d-(c-1)*(w-1)))/(w-1),v=1/Math.sqrt(1+p*p),b=v*p;for(h=1;h<=t;++h){var y=s.data[(r-1)*s.nbColumns+(h-1)],g=s.data[(m-1)*s.nbColumns+(h-1)];s.data[(r-1)*s.nbColumns+(h-1)]=v*y-b*g,s.data[(m-1)*s.nbColumns+(h-1)]=b*y+v*g}for(h=1;h<=t;++h){y=s.data[(h-1)*s.nbColumns+(r-1)],g=s.data[(h-1)*s.nbColumns+(m-1)];s.data[(h-1)*s.nbColumns+(r-1)]=v*y-b*g,s.data[(h-1)*s.nbColumns+(m-1)]=b*y+v*g}s.data[(r-1)*s.nbColumns+(r-1)]=1}for(h=1;h<=t;++h)s.data[(h-1)*s.nbColumns+(h-1)]=1;for(r=1;r<=t;++r)for(m=r+1;m<=t;++m){d=s.data[(r-1)*s.nbColumns+(m-1)];var x=s.data[(m-1)*s.nbColumns+(r-1)],C=Math.min(1,Math.max(-1,(d+x)/2));s.data[(r-1)*s.nbColumns+(m-1)]=C,s.data[(m-1)*s.nbColumns+(r-1)]=C}return s},it.linsolveExtendedKaczmarz=function(t,r,n){void 0===n&&(n={});var o=n.eps||1e-12,i=n.maxIter||1e5,e=!1;if(void 0!==n.randomized&&(e=n.randomized),!(t instanceof it))throw new Error("first input must be a matrix");if(!(r instanceof it))throw new Error("second input must be a matrix");if(t.nbRows!==r.nbRows)throw new Error("matrix and second member sizes do not match: ("+t.nbRows+","+t.nbColumns+") - ("+r.nbRows+","+r.nbColumns+")");if(1!==r.nbColumns)throw new Error("b is not a vector: ("+r.nbRows+","+r.nbColumns+")");var a=t.nbRows,s=t.nbColumns,u=it.zeros(s,1),l=new it(r),h=it.zeros(a,1),f=it.zeros(a,1),m=it.zeros(a,1),c=t.matrixNorm("frobenius"),d=c*c;if(0===c)return u;for(var w="function"==typeof Float64Array?new Float64Array(a):new Array(a),p=1;p<=a;++p){var v=t.vectorNorm("two","row",p);w[p-1]=v*v}for(var b="function"==typeof Float64Array?new Float64Array(s):new Array(s),y=1;y<=s;++y){var g=t.vectorNorm("two","column",y);b[y-1]=g*g}if(0==e)for(var x=0;;){if(++x,-1!==i&&i<=x)throw new Error("maximum number of iterations reached: "+i);for(p=1;p<=a;++p)if(0!=w[p-1]){var C=0;for(y=1;y<=s;++y)C+=t.data[(p-1)*t.nbColumns+(y-1)]*u.data[(y-1)*u.nbColumns];var R=C-(r.data[(p-1)*r.nbColumns+0]-l.data[(p-1)*l.nbColumns+0]);for(y=1;y<=s;++y)u.data[(y-1)*u.nbColumns]-=R/w[p-1]*t.data[(p-1)*t.nbColumns+(y-1)]}for(y=1;y<=s;++y)if(0!=b[y-1]){var E=0;for(p=1;p<=a;++p)E+=t.data[(p-1)*t.nbColumns+(y-1)]*l.data[(p-1)*l.nbColumns+0];for(p=1;p<=a;++p)l.data[(p-1)*l.nbColumns+0]-=E/b[y-1]*t.data[(p-1)*t.nbColumns+(y-1)]}var A=u.vectorNorm("two");if(m=it.xy(t,u,m),f=it.xmy(r,l,f),(I=(h=it.xmy(m,f,h)).vectorNorm("two"))<=o*c*A)break}else{var M=it.zeros(s,1),P="function"==typeof Float64Array?new Float64Array(a):new Array(a);for(p=1;p<=a;++p)P[p-1]=w[p-1]/d;var _=new N(P),z="function"==typeof Float64Array?new Float64Array(s):new Array(s);for(y=1;y<=s;++y)z[y-1]=b[y-1]/d;var k=new N(z);for(x=0;;){if(++x,-1!==i&&i<=x)throw new Error("maximum number of iterations reached: "+i);for(p=_.sample()+1,C=0,y=1;y<=s;++y)C+=t.data[(p-1)*t.nbColumns+(y-1)]*u.data[(y-1)*u.nbColumns];for(R=C-(r.data[(p-1)*r.nbColumns+0]-l.data[(p-1)*l.nbColumns+0]),y=1;y<=s;++y)u.data[(y-1)*u.nbColumns]-=R/w[p-1]*t.data[(p-1)*t.nbColumns+(y-1)];for(y=k.sample()+1,E=0,p=1;p<=a;++p)E+=t.data[(p-1)*t.nbColumns+(y-1)]*l.data[(p-1)*l.nbColumns+0];for(p=1;p<=a;++p)l.data[(p-1)*l.nbColumns+0]-=E/b[y-1]*t.data[(p-1)*t.nbColumns+(y-1)];if(x%8*Math.min(a,s)==0){A=u.vectorNorm("two");m=it.xy(t,u,m),f=it.xmy(r,l,f);var I=(h=it.xmy(m,f,h)).vectorNorm("two"),S=(M=it.txy(t,l,M)).vectorNorm("two");if(I<=o*c*A&&S<=o*d*A)break}}}return u},y.meanVector=function(n,t){void 0===(t=t)&&(t={});var r=t.regularizationMethod;if(void 0===r&&(r="none"),"none"!=r&&"linear-shrinkage"!=r)throw new Error("unsupported mean vector regularization method");var o,i=n.length,e=n[0].length;if("none"==r){o=a=it.fill(i,1,function(t,r){return I(n[t-1])})}else{if("linear-shrinkage"!=r)throw new Error("internal error: unsupported mean vector regularization method");var a,s=I((a=it.fill(i,1,function(t,r){return I(n[t-1])})).toArray()),u=it.fill(i,1,function(t,r){return s}),l=it.fill(i,1,function(t,r){return F(n[t-1],n[t-1])}).sum()/i,h=i/e*l/(i/e*l+Math.pow(it.xmy(u,a).vectorNorm("two"),2));o=it.axpby(h,u,1-h,a)}return o},y.randomMeanVector=function(t,r){var n=null==r?1:r;return it.fill(t,1,function(t,r){return S(0,n)})},y.perturbedMeanVector=function(t,r){if(void 0===(r=r)&&(r={}),void 0===r.method&&(r.method="multiplicative-noise"),"multiplicative-noise"!=r.method)throw new Error("unsupported perturbation method");var o=r.sigma;if(void 0===r.sigma&&(o=.05),!(t=new it(t)).isVector())throw new Error("input must be a vector");return t.elemMap(function(t,r,n){return n*(1+o*S(0,1))})},y.randomVariances=function(t,r){var n=null==r?1:r;return it.fill(t,1,function(t,r){return e(0,n)})},y.perturbedVariances=function(t,r){if(void 0===(r=r)&&(r={}),void 0===r.method&&(r.method="multiplicative-noise"),"multiplicative-noise"!=r.method)throw new Error("unsupported perturbation method");var i=r.sigma;if(void 0===r.sigma&&(i=.05),!(t=new it(t)).isVector())throw new Error("input must be a vector");return t.elemMap(function(t,r,n){for(var o=n*(1+i*S(0,1));o<=0;)o=n*(1+i*S(0,1));return o})},(y.BitSet_=nt).populationCount=function(t){return t=(t=(858993459&(t-=t>>>1&1431655765))+(t>>>2&858993459))+(t>>>4)&252645135,t+=t>>>8,63&(t+=t>>>16)},nt.prototype={constructor:nt,resize:function(t){var r=this.words.length;if(!(r<<this.WORD_LOG>t)){var n=t+this.WORD_LENGTH>>>this.WORD_LOG;if("function"==typeof Uint32Array){var o=new Uint32Array(n);o.set(this.words),this.words=o}else{this.words[n-1]=0;for(var i=r;i<n-1;++i)this.words[i]=0}}},toString:function(){for(var t="",r=this.words.length,n=0;n<r;++n){var o="";t+=(o="function"==typeof Uint32Array?this.words[n].toString(2):(this.words[n]>>>0).toString(2)).length>=this.WORD_LENGTH?o:new Array(this.WORD_LENGTH-o.length+1).join("0")+o}return t},set:function(t){return this.words.length<<this.WORD_LOG<=t&&this.resize(t),this.words[t>>>this.WORD_LOG]|=1<<t,this},setRange:function(t,r){this.words.length<<this.WORD_LOG<=r&&this.resize(r);for(var n=t;n<=r;++n)this.words[n>>>this.WORD_LOG]|=1<<n;return this},unset:function(t){return this.words.length<<this.WORD_LOG<=t&&this.resize(t),this.words[t>>>this.WORD_LOG]&=~(1<<t),this},get:function(t){return 0!=(this.words[t>>>this.WORD_LOG]&1<<t)},clear:function(){return this.words="function"==typeof Uint32Array?new Uint32Array(0):new Array(0),this},flip:function(t){return this.words.length<<this.WORD_LOG<=t&&this.resize(t),this.words[t>>>this.WORD_LOG]^=1<<t,this},isEmpty:function(){for(var t=this.words.length,r=0;r<t;++r)if(0!=this.words[r])return!1;return!0},nbSetBits:function(){for(var t=0,r=this.words.length,n=0;n<r;++n)t+=nt.populationCount(0|this.words[n]);return t},toArray:function(){for(var t=new Array(this.nbSetBits()),r=0,n=this.words.length,o=0;o<n;++o)for(var i=this.words[o];0!=i;){var e=i&-i;t[r++]=(o<<this.WORD_LOG)+nt.populationCount(e-1|0),i^=e}return t}},y.aliasMethodSampler_=N,y.randomCompositionsIterator_=function(t,r){this.n=t,this.k=r,this.ranksb=new x(t+r-1,r-1),this.r="function"==typeof Uint32Array?new Uint32Array(r):new Array(r),this.next=function(){for(var t=this.ranksb.next(),r=0;r<this.k-1;++r)this.r[r]=t[r];this.r[this.k-1]=this.n+this.k;var n=0;for(r=1;r<=this.k;++r){var o=this.r[r-1];this.r[r-1]=o-n-1,n=o}return this.r.slice(0)}},y.compositionsIterator_=o,y.permutationsIterator_=function(t,r){this.n=t,this.reuseOutputArray=r,this.p="function"==typeof Uint32Array?new Uint32Array(this.n):new Array(this.n);for(var n=0;n<this.n;++n)this.p[n]=n+1;this.c="function"==typeof Uint32Array?new Uint32Array(this.n):new Array(this.n);for(n=0;n<this.n;++n)this.c[n]=0;this.j=-1,this.next=function(){if(this.j>=this.n)return-1;if(-1===this.j)return++this.j,this.reuseOutputArray?this.p:this.p.slice(0);for(;this.j<this.n;){if(this.c[this.j]<this.j){if(this.j%2==0){var t=this.p[this.j];this.p[this.j]=this.p[0],this.p[0]=t}else{t=this.p[this.j];this.p[this.j]=this.p[this.c[this.j]],this.p[this.c[this.j]]=t}return++this.c[this.j],this.j=0,this.reuseOutputArray?this.p:this.p.slice(0)}this.c[this.j]=0,++this.j}return-1}},y.subsetsIterator_=g,y.kSubsetsIterator_=R,y.randomKSubsetsIterator_=x,y.randomPermutationsIterator_=U,y.binomial_=C,y.geometricCenter_=E,y.geometricMedian_=A,y.max_=D,y.median_=function(t,r){var n=t.length;return W(t.slice(),Math.ceil(n/2),r)},y.select_=W,y.quantile_=M,y.permutationEntropy_=function(t,r){for(var n=t.length,o={},i=0,e=n-r+1,a="function"==typeof UInt32Array?new UInt32Array(r):new Array(r),s=0;s<e;++s){for(var u=t.slice(s,s+r),l=0;l<r;++l)a[l]=l+1;a.sort(function(t,r){return u[t-1]-u[r-1]});var h=a.toString();o[h]=(o[h]||0)+1,++i}var f=0;for(var m in o)if(o.hasOwnProperty(m)){var c=o[m]/i;f+=c*Math.log(c)}return-f/Math.log(2)},y.hypot_=f,y.rank_=d,y.ftca_=b,y.normcdf_=_,y.norminv_=s,y.normrnd_=S,y.pnormrnd_=e,y.hypersphereRandomSampler_=V,y.boxRandomSampler_=P,y.boxGridSampler_=function(t,r,n,o,i){this.n=t,this.k=r,this.reuseOutputArray=i,this.arrs="function"==typeof UInt32Array?new UInt32Array(this.n):new Array(this.n);for(var e=0;e<this.n;++e)this.arrs[e]=0;if(this.x="function"==typeof Float64Array?new Float64Array(this.n):new Array(this.n),this.l=n,!this.l){this.l="function"==typeof Float64Array?new Float64Array(this.n):new Array(this.n);for(e=0;e<this.n;++e)this.l[e]=0}if(this.u=o,!this.u){this.u="function"==typeof Float64Array?new Float64Array(this.n):new Array(this.n);for(e=0;e<this.n;++e)this.u[e]=1}this.nbGridPoints="function"==typeof UInt32Array?new UInt32Array(this.n):new Array(this.n),this.gridSize="function"==typeof Float64Array?new Float64Array(this.n):new Array(this.n);for(e=0;e<this.n;++e){var a;a=this.k[e]?this.k[e]:this.k,this.nbGridPoints[e]=a,this.gridSize[e]=1===a?0:(this.u[e]-this.l[e])/(this.nbGridPoints[e]-1)}for(e=0;e<this.n;++e){var s=this.l[e],u=this.u[e];if(u<s)throw new Error("infeasible problem detected: lower bound "+s+" strictly greater than upper bound "+u);if(s<u&&this.gridSize[e]<=0)throw new Error("incorrect number of grid points to generate on the interval ["+s+", "+u+"]: "+this.nbGridPoints[e])}this.sample=function(){if(this.arrs[0]===this.nbGridPoints[0])return-1;for(var t=0;t<this.n;++t)this.x[t]=this.l[t]+this.arrs[t]*this.gridSize[t];for(var r=!0,n=this.n-1;r&&0<=n;){if(++this.arrs[n],this.arrs[n]===this.nbGridPoints[n]){if(0===n)break;r=!(this.arrs[n]=0)}else r=!1;--n}return this.reuseOutputArray?this.x:this.x.slice(0)}},y.lineSegmentEuclidianProjection_=v,y.lpsolvePDHG_=m,y.qpsolveGSMO_=G,y.qksolveBS_=L,y.ccpsolveFISTA_=B,y.gssSolve_=function(t,r,n,o,i){function e(t,r,n,o){if(this.n=t.nbRows,this.alpha=r,this.nbGeneratedPollingDirections=0,this.d=it.zeros(a,1),this.nbPollingDirections,this.pollingDirectionsIndices,n&&o){this.nbPollingDirections=n.length+o.length,this.pollingDirectionsIndices="function"==typeof Int32Array?new Int32Array(this.nbPollingDirections):new Array(this.nbPollingDirections);for(var i=0;i<n.length;++i)this.pollingDirectionsIndices[i]=n[i];i=n.length;for(var e=0;i<this.nbPollingDirections;++i,++e)this.pollingDirectionsIndices[i]=-o[e]}else{this.nbPollingDirections=2*this.n,this.pollingDirectionsIndices="function"==typeof Int32Array?new Int32Array(this.nbPollingDirections):new Array(this.nbPollingDirections);for(i=0;i<this.n;++i)this.pollingDirectionsIndices[i]=i+1;for(i=this.n,e=0;i<2*this.n;++i,++e)this.pollingDirectionsIndices[i]=-(e+1)}this.next=function(){if(this.nbGeneratedPollingDirections>=this.nbPollingDirections)return-1;if(1<=this.nbGeneratedPollingDirections){var t=this.pollingDirectionsIndices[this.nbGeneratedPollingDirections-1];if(t<0)this.d.data[-t-1]=0;else{if(!(0<t))throw new Error("internal error: 0 polling direction indice detected");this.d.data[t-1]=0}}var r=this.pollingDirectionsIndices[this.nbGeneratedPollingDirections];if(r<0)this.d.data[-r-1]=-1;else{if(!(0<r))throw new Error("internal error: 0 polling direction indice detected");this.d.data[r-1]=1}return++this.nbGeneratedPollingDirections,this.d}}var a=r.nbRows;void 0===i&&(i={});var s=i.maxIter;void 0===s&&(s=1e4);var u=i.eps;void 0===u&&(u=1e-6);if(n&&o){if(n.length!=o.length)throw new Error("incompatible number of lower bounds and upper bounds constraints: "+n.length+" v.s. "+o.length);n=new it(n),o=new it(o)}{if(n&&!o)throw new Error("missing upper bounds constraints");if(!n&&o)throw new Error("missing lower bounds constraints")}var l,h=i.unconstrainedPollingSet;void 0===h&&(h="coordinateDirections");if("coordinateDirections"!==h&&"probabilisticDescentDirections"!==h&&"custom"!==h)throw new Error("unsupported unconstrained polling set");if("coordinateDirections"===h)l=e;else if("probabilisticDescentDirections"===h)l=function(t,r){this.n=t.nbRows,this.nbGeneratedPollingDirections=0,this.d=it.zeros(a,1),this.nbPollingDirections=Math.floor(Math.log(1-Math.log(p)/Math.log(w))/Math.log(2))+1,this.hypersphereRandomSampler=new V(this.n,!0),this.next=function(){if(this.nbGeneratedPollingDirections>=this.nbPollingDirections)return-1;if(2===this.nbPollingDirections&&1===this.nbGeneratedPollingDirections)this.d=it.ax(-1,this.d,this.d);else{var n=this.hypersphereRandomSampler.sample();this.d=it.fill(this.n,1,function(t,r){return n[t-1]},this.d)}return++this.nbGeneratedPollingDirections,this.d}};else{if("custom"!==h)throw new Error("internal error: unsupported unconstrained polling set detected");l=i.customUnconstrainedPollingSetGenerator}var f,m=i.constrainedPollingSet;void 0===m&&(m="coordinateDirections");if("coordinateDirections"!==m&&"custom"!==m)throw new Error("unsupported constrained polling set");if("coordinateDirections"===m)f=e;else{if("custom"!==m)throw new Error("internal error: unsupported constrained polling set detected");f=i.customConstraintedPollingSetGenerator}var c=i.alphaZero;void 0===c&&(c=1);var d=i.alphaMax;void 0===d&&(d=1e10);var w=i.gamma;if(void 0===w)if("coordinateDirections"===h)w=1;else if("probabilisticDescentDirections"===h)w=2;else{if("custom"!==h)throw new Error("internal error: unsupported unconstrained polling set detected");w=1}var p=i.theta;void 0===p&&(p=.5);var v=i.pollingType;void 0===v&&(v="opportunistic");if("opportunistic"!==v&&"complete"!==v)throw new Error("unsupported polling type");var b=i.rho;void 0===b&&(b=function(t){return t*t/2});var y=new it(r),g=new it(r),x=new it(r),C=t(y),R=t(g),E=void 0,A=c,M=0;for(;;){if(-1!==s&&s<M)throw new Error("maximum number of iterations reached: "+s);++M;var P=b(A),_=!1;if(n&&o)for(var z=new Array(0),k=new Array(0),I=0;I<a;++I)y.data[I]+A<=o.data[I]-1e-12&&z.push(I+1),n.data[I]+1e-12<=y.data[I]-A&&k.push(I+1);for(var S,F=(S=n&&o&&z.length+k.length<2*a?new f(y,A,z,k):new l(y,A)).next();-1!=F;){if(g=it.axpby(1,y,A,F,g),(R=t(g))<C-P){if(_=!0,"opportunistic"===v){x=it.copy(g,x),E=R;break}"complete"===v&&(void 0===E?(x=it.copy(g,x),E=R):R<E&&(x=it.copy(g,x),E=R))}F=S.next()}if(!0===_&&(y=it.copy(x,y),C=E,E=void 0),!0===_?A=Math.min(w*A,d):A*=p,A<=u)break}return[y,C]},y.thresholdAcceptingSolve_=T,y.bisection_=q,y.goldenSectionSearch_=c,y.returns=function(t,r){void 0===(r=r)&&(r={}),void 0===r.method&&(r.method="arithmetic");var n=r.method;if("arithmetic"!=n&&"logarithmic"!=n)throw new Error("unsupported returns computation method");var o="function"==typeof Float64Array?new Float64Array(t.length-1):new Array(t.length-1);if("arithmetic"==n)for(var i=0;i<t.length-1;++i){if(0==t[i])throw new Error("internal error: null input value");o[i]=(t[i+1]-t[i])/t[i]}else{if("logarithmic"!=n)throw new Error("internal error: unsupported returns computation method");for(i=0;i<t.length-1;++i){if(t[i]<=0||t[i+1]<=0)throw new Error("internal error: negative or null input value");o[i]=Math.log(t[i+1]/t[i])}}return o},y.fullSimplexCharacteristicFunction_=function(t,r,n){var o=t.length;l(o,r,n);for(var i=0,e=0;e<o;++e){var a=0;r&&(a=r[e]);var s=1;n&&(s=n[e]);var u=t[e];if(u<a||s<u)return Number.POSITIVE_INFINITY;i+=u}if(1e-12<i-1)return Number.POSITIVE_INFINITY;return 0},y.simplexCharacteristicFunction_=H,y.simplexEmptinessCheck_=Y,y.fullSimplexEmptinessCheck_=l,y.simplexRationalRounding_=function(t,r){for(var n=r,o=new Array(t.length),i=0;i<t.length;++i){var e=r*t[i],a=Math.floor(e),s=e-a;n-=a,o[i]=[a,s,i]}o.sort(function(t,r){return r[1]<t[1]?-1:r[1]>t[1]?1:r[0]-t[0]});var u=new Array(t.length);for(i=0;i<n;++i){var l=o[i][2];u[l]=(o[i][0]+1)/r}for(i=n;i<o.length;++i){l=o[i][2];u[l]=o[i][0]/r}return u},y.simplexRandomSampler_=Q,y.simplexDirectionRandomSampler_=function(t){this.n=t,this.x="function"==typeof Float64Array?new Float64Array(t):new Array(t),this.sample=function(){for(var t=0,r=0;r<this.n;++r){var n=S(0,1);t+=this.x[r]=n}var o=t/this.n,i=0,e=1;for(r=0;r<this.n;++r){this.x[r]=this.x[r]-o;var a=Math.abs(this.x[r]);0!=a&&(i<a?(e=1+e*(i/this.x[r])*(i/this.x[r]),i=a):e+=this.x[r]/i*(this.x[r]/i))}var s=i*Math.sqrt(e);for(r=0;r<this.n;++r)this.x[r]=this.x[r]/s;return this.x.slice(0)}},y.simplexGridSampler_=J,y.simplexGridSearch_=u,y.simplexEuclidianProjection_=Z,y.fullSimplexEuclidianProjection_=K,y.simplexSparseEuclidianProjection_=function(n,t,r,o){var i=n.length;if(t===i)return Z(n,r,o);{if(r||o){n=new it(n);for(var e=1/0,a=null,s=1;s<=t;++s)for(var u=new R(i,s,!1),l=u.next();-1!=l;){var h=l.length,f="function"==typeof UInt32Array?new UInt32Array(h):new Array(h);for(y=0;y<h;++y)f[y]=l[y];var m="function"==typeof Float64Array?new Float64Array(h):new Array(h);for(y=0;y<h;++y)m[y]=n.data[f[y]-1];var c="function"==typeof Float64Array?new Float64Array(h):new Array(h);if(r)for(y=0;y<h;++y)c[y]=r[f[y]-1];else for(y=0;y<h;++y)c[y]=0;var d="function"==typeof Float64Array?new Float64Array(h):new Array(h);if(o)for(y=0;y<h;++y)d[y]=o[f[y]-1];else for(y=0;y<h;++y)d[y]=1;try{var w=Z(m,c,d),p=it.zeros(i,1);for(y=0;y<h;++y)p.data[f[y]-1]=w[y];var v=it.axpby(1,n,-1,p).vectorNorm("two");v<e&&(e=v,f,a=p)}catch(t){if("infeasible problem detected: the restricted simplex is empty"!==t.message)throw t}l=u.next()}if(e!=1/0)return a.toArray();throw new Error("infeasible problem detected")}for(var b="function"==typeof UInt32Array?new UInt32Array(i):new Array(i),y=0;y<i;++y)b[y]=y;W(b,t,function(t,r){return n[r]-n[t]});for(var g=n.slice(0,t),y=0;y<t;++y)g[y]=n[b[y]];for(var x=Z(g),C="function"==typeof Float64Array?new Float64Array(i):new Array(i),y=0;y<t;++y)C[b[y]]=x[y];for(var y=t;y<i;++y)C[b[y]]=0;return C}},y.simplexLpSolve_=ot,y.bestConstantlyRebalancedWeights=function(h,t){void 0===t&&(t={constraints:{}}),void 0===t.constraints&&(t.constraints={}),void 0===t.eps&&(t.eps=1e-4),void 0===t.maxIter&&(t.maxIter=1e4);var r=t.eps,n=t.maxIter,o=t.constraints.minWeights,i=t.constraints.maxWeights,f=h.length,m=h[0].length;return B(function(t){for(var r=it.zeros(f,1),n=1,o=0;o<m;++o)r=it.fill(f,1,function(t,r){return h[t-1][o]},r),n*=it.vectorDotProduct(t,r);return-n},function(t){for(var r,n=it.zeros(f,1),o="function"==typeof Float64Array?new Float64Array(m):new Array(m),i=1,e=!1,a=0;a<m;++a){n=it.fill(f,1,function(t,r){return h[t-1][a]},n);var s=it.vectorDotProduct(t,n);o[a]=s,!1===e&&(i*=s,Math.abs(s)<=1e-12&&(e=!0))}if(!1!==e)throw new Error("null portfolio relative detected, unsuported case");r=it.fill(m,1,function(t,r){return i/o[t-1]});var u=it.zeros(m,1),l=it.zeros(f,1);for(a=0;a<f;++a)u=it.fill(m,1,function(t,r){return h[a][t-1]},u),l.data[a]=-it.vectorDotProduct(u,r);return l},function(t){return H(t.data,o,i)},function(t){return new it(Z(t.data,o,i))},new it(Z(it.ones(f,1).data,o,i)),{eps:r,maxIter:n,maxLine:n})[0].toArray()},y.clusterRiskParityWeights=function(t,r){void 0===r&&(r={});var n=r.clusteringMode||"ftca",o=(t=new it(t).toCovarianceMatrix(t)).nbRows,i=[];if("manual"===n){i=r.clusters||[];for(var e=new Array(o),a=0;a<e.length;++a)e[a]=0;for(var s=0;s<i.length;++s){if(0===i[s].length)throw new Error("empty cluster at index: "+s);for(var u=0;u<i[s].length;++u){var l=i[s][u];if(l<1||o<l)throw new Error("asset index out of bounds: "+l);e[l-1]++}}for(a=0;a<e.length;++a)if(1!==e[a])throw 0===e[a]?new Error("missing asset index: "+(a+1)):1<e[a]?new Error("duplicate asset index: "+(a+1)):new Error("unknown error")}else{if("ftca"!==n)throw new Error("unsupported clustering method");i=b(t.getCorrelationMatrix().toRowArray(),r.ftcaThreshold)}var h=i.length,f=it.zeros(h,o);for(a=0;a<h;++a){var m=i[a].slice().sort(function(t,r){return t-r}),c=t.submatrix(m,m),d=y.equalRiskContributionWeights(c,r);for(s=0;s<d.length;++s)f.setValueAt(a+1,m[s],d[s])}var w=it.xy(f,it.axty(1,t,f)),p=y.equalRiskContributionWeights(w,r);return it.txy(f,new it(p)).toArray()},y.equalRiskBoundingWeights=function(t,r){void 0===r&&(r={}),void 0===r.constraints&&(r.constraints={});var n=(t=new it(t)).nbRows,o=1/0,i=[],e=[],a=new g(n),s=a.next();for(s=a.next();-1!=s;){var u,l,h=s,f=h.length,m=t.submatrix(h,h);if(r.constraints.minWeights){u="function"==typeof Float64Array?new Float64Array(f):new Array(f);for(var c=0;c<f;++c)u[c]=r.constraints.minWeights[h[c]-1]}if(r.constraints.maxWeights){l="function"==typeof Float64Array?new Float64Array(f):new Array(f);for(c=0;c<f;++c)l[c]=r.constraints.maxWeights[h[c]-1]}try{var d=y.equalRiskContributionWeights(m,{eps:r.eps,maxCycles:-1,outputPortfolioVolatility:!0,constraints:{minWeights:u,maxWeights:l}}),w=d[0],p=d[1],v=p*p/f;v<o&&(o=v,i=h,e=w)}catch(t){if("infeasible problem detected: the restricted simplex is empty"!==t.message&&"internal error: maximum number of iterations reached when searching for a bracketing interval, the problem might be infeasible"!==t.message)throw t}s=a.next()}if(o==1/0)throw new Error("no feasible portfolio generated");var b=it.zeros(n,1);for(c=0;c<i.length;++c)b.setValueAt(i[c],1,e[c]);return b.toArray()},y.equalRiskContributionWeights=function(t,r){var n=(t=new it(t)).nbRows,o=it.fill(n,1,function(t,r){return 1/n});return y.riskBudgetingWeights(t,o,r)},y.equalWeights=function(n,t){return it.fill(n,1,function(t,r){return 1/n}).toArray()},y.globalMinimumVarianceWeights=function(t,r){void 0===r&&(r={}),void 0===r.constraints&&(r.constraints={}),void 0===r.optimizationMethodParams&&(r.optimizationMethodParams={});var n,o=(t=new it(t)).nbRows;n=null==r.mu?it.zeros(o,1):new it(r.mu);var i,e=r.optimizationMethod;if(void 0===e&&(e="automatic"),"critical-line"!=e&&"gsmo"!=e&&"automatic"!=e)throw new Error("unsupported optimisation method");if(r.optimizationMethodParams.minimumRiskToleranceValueOnlyGsmo=!0,"automatic"==e)i=new $(n,t,r);else if("critical-line"==e)i=new X(n,t,r);else{if("gsmo"!=e)throw new Error("internal error: unsupported optimisation method");i=new et(n,t,r)}return i.getLowestRiskTolerancePortfolio().toArray()},y.inverseVolatilityWeights=function(t,r){var n=new it(t).elemMap(function(t,r,n){return 1/Math.sqrt(n)});return(n=n.normalize(n)).toArray()},y.maximumSharpeRatioWeights=function(t,r,n,o){void 0===o&&(o={constraints:{}}),void 0===o.constraints&&(o.constraints={}),void 0===o.optimizationMethodParams&&(o.optimizationMethodParams={});var i=o.optimizationMethod;if(void 0===i&&(i="automatic"),"critical-line"!=i&&"gsmo"!=i&&"automatic"!=i)throw new Error("unsupported optimisation method");var e,a=o.epsVolatility;if(void 0===a&&(a=1e-4),"automatic"==i)e=new $(t,r,o);else if("critical-line"==i)e=new X(t,r,o);else{if("gsmo"!=i)throw new Error("internal error: unsupported optimisation method");e=new et(t,r,o)}return e.restrict("minVolatility",a),e.restrict("minReturn",n),e.computeMaximumSharpeRatioEfficientPortfolio(n)[0].toArray()},(((y.MeanVarianceEfficientFrontierCla=X).prototype=Object.create(h.prototype)).constructor=X).prototype.getHighestRiskTolerancePortfolio=function(t){return this.cornerPortfolios[0][0]},X.prototype.getHighestRiskTolerance=function(t){return this.cornerPortfolios[0][1]},X.prototype.getLowestRiskTolerancePortfolio=function(t){return this.cornerPortfolios[this.cornerPortfolios.length-1][0]},X.prototype.getLowestRiskTolerance=function(t){return this.cornerPortfolios[this.cornerPortfolios.length-1][1]},X.prototype.computeEfficientPortfolio=function(t,r){if(null==t)throw new Error("missing constraint type");var n,e=this;if("return"==t)n=function(t){return e.computePortfolioReturn(t[0])};else if("volatility"==t)n=function(t){return e.computePortfolioVolatility(t[0])};else{if("riskTolerance"!=t)throw new Error("unknown constraint type");n=function(t){return t[1]}}if(null==r)throw new Error("missing constraint value");var o=function(t,r,n,o){var i=n.length-1,e=0,a=(n[i][0],n[e][0],t(n[i])),s=t(n[e]);if(s+o<r||r<a-o)return[];{if(Math.abs(r-a)<=o)return[i];if(Math.abs(r-s)<=o)return[e]}for(;i-e!=1;){var u=Math.floor((i+e)/2),l=t(n[u]);if(r<l)e=u;else{if(!(l<r))return[u];i=u}}return[i,e]}(n,r,this.cornerPortfolios,this.epsEfficientPortfolioComputation);if(0==o.length)return[];if(1==o.length){var i=o[0];return[this.cornerPortfolios[i][0],this.cornerPortfolios[i][1]]}i=o[0];var a,s=this.cornerPortfolios[i][0],u=n(this.cornerPortfolios[i]),l=o[1],h=this.cornerPortfolios[l][0],f=n(this.cornerPortfolios[l]);if("return"===t)a=(f-r)/(f-u);else if("volatility"===t){var m=it.vectorDotProduct(it.xy(this.sigma,s),h),c=u*u+f*f-2*m,d=f*f-r*r,w=-2*(f*f-m)/2,p=0<=w?1:-1,v=w*w-c*d;if(v<0)throw new Error("internal error; the covariance matrix might not be semi-definite positive");var b=-(w+p*Math.sqrt(v)),y=b/c,g=d/b;if(0<y&&y<1)a=y;else{if(!(0<g&&g<1))throw new Error("internal error: the covariance matrix might not be semi-definite positive");a=g}}else{if("riskTolerance"!==t)throw new Error("internal error: unknown constraint type");a=(f-r)/(f-u)}e=this;return[it.fill(s.nbRows,1,function(t,r){var n=a*s.getValue(t,1)+(1-a)*h.getValue(t,1),o=e.lowerBounds.data[t-1],i=e.upperBounds.data[t-1];return Math.max(Math.min(n,i),o)}),a*this.cornerPortfolios[i][1]+(1-a)*this.cornerPortfolios[l][1]]},X.prototype.getCornerPortfolios=function(){for(var t=new Array(this.cornerPortfolios.length),r=0;r<t.length;++r)t[r]=new it(this.cornerPortfolios[r][0]);return t},X.prototype.restrict=function(t,r){if(null==t)throw new Error("missing constraint type");if(null==r)throw new Error("missing constraint value");if("minReturn"==t){if(this.getLowestReturn()<r){if(this.getHighestReturn()<r)throw new Error("impossible to restrict the efficient frontier: the minimum return constraint is not feasible");if(0==(a=this.computeEfficientPortfolio("return",r+.5*this.epsEfficientPortfolioComputation)).length)throw new Error("internal error: no efficient portfolio with a return greater than "+r);var n=a[0],o=a[1],e=new Array;for(i=0;i<this.cornerPortfolios.length-1&&this.cornerPortfolios[i][1]>o;++i)e.push(this.cornerPortfolios[i]);e.push([n,o]),this.cornerPortfolios=e}}else{if("minVolatility"!=t)throw new Error("unknown constraint type");if(this.getLowestVolatility()<r){var a;if(this.getHighestVolatility()<r)throw new Error("impossible to restrict the efficient frontier: the minimum volatility constraint is not feasible");if(0==(a=this.computeEfficientPortfolio("volatility",r+.5*this.epsEfficientPortfolioComputation)).length)throw new Error("internal error: no efficient portfolio with a volatility greater than "+r+": the covariance matrix might not be semi-definite positive");n=a[0],o=a[1],e=new Array;for(i=0;i<this.cornerPortfolios.length-1&&this.cornerPortfolios[i][1]>o;++i)e.push(this.cornerPortfolios[i]);e.push([n,o]),this.cornerPortfolios=e}}},X.prototype.computeMaximumSharpeRatioEfficientPortfolio=function(t){var r=function(t){var r=this.cornerPortfolios.length-1,n=0;if(r==n)return r;for(;r-n!=1;){var o=Math.floor((r+n)/2),i=this.cornerPortfolios[o][0],e=this.computePortfolioSharpeRatio(i,t),a=o+1,s=this.cornerPortfolios[a][0],u=this.computePortfolioSharpeRatio(s,t);if(u<e)r=o;else{if(!(e<u)){r=a,n=o;break}n=o}}return r}.call(this,t),n=this.cornerPortfolios[r][0],o=[[n,this.computePortfolioSharpeRatio(n,t),this.cornerPortfolios[r][1]]];r<=this.cornerPortfolios.length-2&&o.push(e.call(this,t,r+1,r)),1<=r&&o.push(e.call(this,t,r,r-1));var i=D(o,function(t,r){return t[1]-r[1]})[0];return[i[0],i[2]];function e(t,r,n){var o=this.cornerPortfolios,i=o[r][0],e=o[n][0],a=this.computePortfolioSharpeRatio(i,t),s=this.computePortfolioReturn(i),u=this.computePortfolioVolatility(i),l=u*u,h=this.computePortfolioSharpeRatio(e,t),f=this.computePortfolioReturn(e),m=this.computePortfolioVolatility(e),c=m*m,d=s-f,w=f-t,p=d*d,v=2*d*w,b=w*w,y=it.vectorDotProduct(it.xy(this.sigma,i),e),g=l+c-2*y,x=-2*(c-y),C=p*x-v*g,R=v*c-b*x,E=2*(p*c-b*g)/2,A=0<=E?1:-1,M=E*E-C*R;if(Math.abs(M)<=1e-16&&(M=0),M<0)throw new Error("internal error, the covariance matrix might not be semi-definite positive");var P=-(E+A*Math.sqrt(M)),_=P/C,z=R/P,k=[[i,a,o[r][1]],[e,h,o[n][1]]];if(0<_&&_<1){var I=it.fill(i.nbRows,1,function(t,r){return _*i.getValue(t,1)+(1-_)*e.getValue(t,1)}),S=this.computePortfolioSharpeRatio(I,t),F=_*o[r][1]+(1-_)*o[n][1];k.push([I,S,F])}if(0<z&&z<1){var V=it.fill(i.nbRows,1,function(t,r){return z*i.getValue(t,1)+(1-z)*e.getValue(t,1)}),O=this.computePortfolioSharpeRatio(V,t),T=z*o[r][1]+(1-z)*o[n][1];k.push([V,O,T])}return D(k,function(t,r){return t[1]-r[1]})[0]}},(((y.MeanVarianceEfficientFrontierGsmo=et).prototype=Object.create(h.prototype)).constructor=et).prototype.getHighestRiskTolerancePortfolio=function(t){return this.highestRiskTolerancePortfolio},et.prototype.getHighestRiskTolerance=function(t){return this.highestRiskTolerance},et.prototype.getLowestRiskTolerancePortfolio=function(t){return this.lowestRiskTolerancePortfolio},et.prototype.getLowestRiskTolerance=function(t){return this.lowestRiskTolerance},et.prototype.computeEfficientPortfolio=function(t,i){if(null==t)throw new Error("internal error: missing constraint type");var e,a,s=this;if("return"==t)e=function(t){return s.computePortfolioReturn(t)},a=function(t){return t.ret};else if("volatility"==t)e=function(t){return s.computePortfolioVolatility(t)},a=function(t){return t.volatility};else if("riskTolerance"!=t)throw new Error("internal error: unknown constraint type");if(null==i)throw new Error("internal error: missing constraint value");var u,r,n=this.nbAssets,l=this.mu,o=this.sigma,h=this.lowerBounds,f=this.upperBounds,m=this.epsEfficientPortfolioComputation,c=o,d=it.ones(n,1),w=h,p=f;if("return"===t||"volatility"===t){var v=this.getLowestRiskTolerancePortfolio(),b=e(v),y=this.getHighestRiskTolerancePortfolio(),g=e(y);if(g+m<i||i<b-m)return[];if(Math.abs(i-b)<=m)u=v,r=this.getLowestRiskTolerance();else if(Math.abs(i-g)<=m)u=y,r=this.getHighestRiskTolerance();else{var x=it.fill(n,1,function(t,r){return 1/n}),C=L(it.ones(n,1),x,d,1,w,p);u=C[0];s=this;r=q(function(t){var r=s.cachedEfficientPortfolios.get(t);if(r)return u=r.weights,a(r)-i;var n=it.ax(-t,l),o=G(c,n,d,1,w,p,{x0:u,antiCycling:s.antiCyclingGsmo,eps:s.epsGsmo,maxIter:s.maxIterationsGsmo});return u=o[0],s.cachedEfficientPortfolios.set(t,{weights:u,ret:s.computePortfolioReturn(u),volatility:s.computePortfolioVolatility(u)}),e(u)-i},this.getLowestRiskTolerance(),this.getHighestRiskTolerance())}}else{if("riskTolerance"!==t)throw new Error("internal error: unknown constraint type");var R=i,E=it.ax(-R,l),A=G(c,E,d,1,w,p,{antiCycling:this.antiCyclingGsmo,eps:this.epsGsmo,maxIter:this.maxIterationsGsmo});u=A[0],r=R}return[u,r]},et.prototype.restrict=function(t,r){if(null==t)throw new Error("missing constraint type");if(null==r)throw new Error("missing constraint value");if("minReturn"==t){if(this.getLowestReturn()<r){if(this.getHighestReturn()<r)throw new Error("impossible to restrict the efficient frontier: the minimum return constraint is not feasible");if(0==(i=this.computeEfficientPortfolio("return",r+.5*this.epsEfficientPortfolioComputation)).length)throw new Error("internal error: no efficient portfolio with a return greater than "+r);var n=i[0],o=i[1];this.lowestRiskTolerancePortfolio=n,this.lowestRiskTolerance=o,this.lowestRiskTolerance>=this.highestRiskTolerance&&(this.highestRiskTolerancePortfolio=n,this.highestRiskTolerance=o)}}else{if("minVolatility"!=t)throw new Error("unknown constraint type");if(this.getLowestVolatility()<r){var i;if(this.getHighestVolatility()<r)throw new Error("impossible to restrict the efficient frontier: the minimum volatility constraint is not feasible");if(0==(i=this.computeEfficientPortfolio("volatility",r+.5*this.epsEfficientPortfolioComputation)).length)throw new Error("internal error: no efficient portfolio with a volatility greater than "+r+": the covariance matrix might not be semi-definite positive");n=i[0],o=i[1];this.lowestRiskTolerancePortfolio=n,this.lowestRiskTolerance=o,this.lowestRiskTolerance>=this.highestRiskTolerance&&(this.highestRiskTolerancePortfolio=n,this.highestRiskTolerance=o)}}},et.prototype.computeMaximumSharpeRatioEfficientPortfolio=function(o){var i,t=this.nbAssets,e=this.mu,r=this.sigma,n=this.lowerBounds,a=this.upperBounds,s=(this.epsEfficientPortfolioComputation,r),u=it.ones(t,1),l=n,h=a,f=this,m=c(function(t){var r=it.ax(-t,e),n=G(s,r,u,1,l,h,{antiCycling:f.antiCyclingGsmo,eps:f.epsGsmo,maxIter:f.maxIterationsGsmo});return i=n[0],-f.computePortfolioSharpeRatio(i,o)},this.getLowestRiskTolerance(),this.getHighestRiskTolerance());return[i,m[0]]},(((y.MeanVarianceEfficientFrontierWrapper=$).prototype=Object.create(h.prototype)).constructor=$).prototype.getHighestRiskTolerancePortfolio=function(t){return this.efficientFrontier.getHighestRiskTolerancePortfolio(t)},$.prototype.getHighestRiskTolerance=function(t){return this.efficientFrontier.getHighestRiskTolerance()},$.prototype.getLowestRiskTolerancePortfolio=function(t){return this.efficientFrontier.getLowestRiskTolerancePortfolio(t)},$.prototype.getLowestRiskTolerance=function(t){return this.efficientFrontier.getLowestRiskTolerance()},$.prototype.computeEfficientPortfolio=function(t,r){return this.efficientFrontier.computeEfficientPortfolio(t,r)},$.prototype.getCornerPortfolios=function(){if("critical-line"==this.efficientFrontierOptimizationMethod)return this.efficientFrontier.getCornerPortfolios();throw new Error("internal error: unsupported method")},$.prototype.restrict=function(t,r){return this.efficientFrontier.restrict(t,r)},$.prototype.computeMaximumSharpeRatioEfficientPortfolio=function(t){return this.efficientFrontier.computeMaximumSharpeRatioEfficientPortfolio(t)},h.prototype.getHighestReturnPortfolio=function(t){return this.getHighestRiskTolerancePortfolio()},h.prototype.getHighestReturn=function(t){return this.computePortfolioReturn(this.getHighestReturnPortfolio())},h.prototype.getLowestReturnPortfolio=function(t){return this.getLowestRiskTolerancePortfolio()},h.prototype.getLowestReturn=function(t){return this.computePortfolioReturn(this.getLowestReturnPortfolio())},h.prototype.getHighestVolatilityPortfolio=function(t){return this.getHighestRiskTolerancePortfolio()},h.prototype.getHighestVolatility=function(t){return this.computePortfolioVolatility(this.getHighestVolatilityPortfolio())},h.prototype.getLowestVolatilityPortfolio=function(t){return this.getLowestRiskTolerancePortfolio()},h.prototype.getLowestVolatility=function(t){return this.computePortfolioVolatility(this.getLowestVolatilityPortfolio())},h.prototype.getHighestRiskTolerancePortfolio=function(t){throw new Error("internal error: function is not implemented")},h.prototype.getHighestRiskTolerance=function(t){throw new Error("internal error: function is not implemented")},h.prototype.getLowestRiskTolerancePortfolio=function(t){throw new Error("internal error: unction is not implemented")},h.prototype.getLowestRiskTolerance=function(t){throw new Error("internal error: function is not implemented")},h.prototype.computePortfolioReturn=function(t){return it.vectorDotProduct(this.mu,t)},h.prototype.computePortfolioVolatility=function(t){var r=it.vectorDotProduct(it.xy(this.sigma,t),t);if(Math.abs(r)<=this.epsPortfolioVolatility)r=0;else if(r<0&&r<-this.epsPortfolioVolatility)throw new Error("internal error: negative volatility, covariance matrix might not be semi-definite positive");return Math.sqrt(r)},h.prototype.computePortfolioSharpeRatio=function(t,r){if(null==r||null==r)throw new Error("internal error: missing risk free rate");var n=this.computePortfolioReturn(t)-r,o=Math.max(this.epsPortfolioVolatility,this.computePortfolioVolatility(t));if(0==o)throw new Error("internal error: null volatility when computing the Sharpe ratio");return n/o},h.prototype.computeEfficientPortfolio=function(t,r){throw new Error("internal error: function is not implemented")},h.prototype.restrict=function(t,r){throw new Error("internal error: function is not implemented")},h.prototype.computeMaximumSharpeRatioEfficientPortfolio=function(t){throw new Error("internal error: function is not implemented")},y.meanVarianceOptimizationWeights=function(t,r,n){void 0===n&&(n={constraints:{}}),void 0===n.constraints&&(n.constraints={}),void 0===n.optimizationMethodParams&&(n.optimizationMethodParams={});var o=n.optimizationMethod;if(void 0===o&&(o="automatic"),"critical-line"!=o&&"gsmo"!=o&&"automatic"!=o)throw new Error("unsupported optimisation method");var i,e,a=n.constraints.return,s=n.constraints.volatility,u=n.constraints.maxVolatility,l=n.constraints.riskTolerance;if(void 0===a&&void 0===s&&void 0===u&&null==l)throw new Error("missing return, volatility or risk tolerance constraints");if(void 0!==a&&void 0!==s||void 0!==a&&void 0!==u)throw new Error("simultaneous return and volatility constraints");if(void 0!==l&&(void 0!==a||void 0!==u||void 0!==s))throw new Error("simultaneous risk tolerance and return or volatility constraints");if("automatic"==o)i=new $(t,r,n);else if("critical-line"==o)i=new X(t,r,n);else{if("gsmo"!=o)throw new Error("internal error: unsupported optimisation method");i=new et(t,r,n)}if(void 0!==a){if(0==(p=i.computeEfficientPortfolio("return",a)).length)throw new Error("no matching efficient portfolio with a return equal to "+a);e=p[0]}else if(void 0!==s){if(0==(p=i.computeEfficientPortfolio("volatility",s)).length)throw new Error("no matching efficient portfolio with a volatility equal to "+s);e=p[0]}else if(void 0!==l){var h=i.getHighestRiskTolerancePortfolio(),f=i.getHighestRiskTolerance(),m=i.getLowestRiskTolerancePortfolio(),c=i.getLowestRiskTolerance();if(f-(d=i.epsEfficientPortfolioComputation)<l)e=h;else if(l<c+d)e=m;else{if(0==(p=i.computeEfficientPortfolio("riskTolerance",l)).length)throw new Error("internal error: no matching efficient portfolio with a risk tolerance equal to "+l);e=p[0]}}else if(void 0!==u){var d,w=i.getHighestVolatilityPortfolio();if(i.getHighestVolatility()-(d=i.epsEfficientPortfolioComputation)<u)e=w;else{var p;if(0==(p=i.computeEfficientPortfolio("volatility",u)).length)throw new Error("no matching efficient portfolio with a volatility lower than or equal to "+u);e=p[0]}}return e.toArray()},y.meanVarianceEfficientFrontierNearestWeights=function(t,r,n,o){void 0===o&&(o={constraints:{}}),void 0===o.constraints&&(o.constraints={}),void 0===o.optimizationMethodParams&&(o.optimizationMethodParams={});var i=o.optimizationMethod;if(void 0===i&&(i="automatic"),"critical-line"!=i&&"gsmo"!=i&&"automatic"!=i)throw new Error("unsupported optimisation method");var e,a;t=new it(t);if("automatic"==i)e=new $(r,n,o);else if("critical-line"==i)e=new X(r,n,o);else{if("gsmo"!=i)throw new Error("internal error: unsupported optimisation method");e=new et(r,n,o)}if("critical-line"==i||"critical-line"==e.efficientFrontierOptimizationMethod)a=e.getCornerPortfolios();else{if("gsmo"!=i&&"gsmo"!=e.efficientFrontierOptimizationMethod)throw new Error("internal error: unsupported optimisation method");var s=o.optimizationMethodParams.nbPortfoliosGsmo;null==s&&(s=100),a=new Array(s);for(var u=e.getLowestReturn(),l=(e.getHighestReturn()-u)/(s-1),h=0;h<s;++h){var f,m=u+h*l;if(0==(f=e.computeEfficientPortfolio("return",m)).length)throw new Error("internal error: no matching efficient portfolio with a return of "+m);a[h]=f[0]}}var c=Number.POSITIVE_INFINITY;for(h=0;h<a.length-1;++h){var d=a[h],w=v(t,a[h+1],d),p=it.xmy(t,new it(w)).vectorNorm("two");p<=c&&(f=w,c=p)}return f},y.meanVarianceEfficientFrontierPortfolios=function(t,r,n){void 0===n&&(n={constraints:{}}),void 0===n.constraints&&(n.constraints={}),void 0===n.optimizationMethodParams&&(n.optimizationMethodParams={});var o=n.optimizationMethod;if(void 0===o&&(o="automatic"),"critical-line"!=o&&"gsmo"!=o&&"automatic"!=o)throw new Error("unsupported optimisation method");var i,e=n.nbPortfolios||100,a=n.discretizationType;if(null==a&&(a="return"),"return"!=a&&"volatility"!=a&&"riskTolerance"!=a)throw new Error("unsupported discretization type");if("automatic"==o)i=new $(t,r,n);else if("critical-line"==o)i=new X(t,r,n);else{if("gsmo"!=o)throw new Error("internal error: unsupported optimisation method");i=new et(t,r,n)}var s,u,l=new Array(e);if("return"==a)s=i.getLowestReturn(),u=i.getHighestReturn();else if("volatility"==a)s=i.getLowestVolatility(),u=i.getHighestVolatility();else{if("riskTolerance"!=a)throw new Error("internal error: unsupported discretization type");s=i.getLowestRiskTolerance(),u=i.getHighestRiskTolerance()}for(var h=1==e?-1:(u-s)/(e-1),f=1==e?(s+u)/2:s,m=0;m<e;++m){var c=f+m*h,d=i.computeEfficientPortfolio(a,c);if(0==d.length)throw new Error("internal error: no matching efficient portfolio with a constraint value "+a+" equal to "+c);d=d[0];var w=i.computePortfolioReturn(d),p=i.computePortfolioVolatility(d);l[m]=[d.toArray(),w,p]}return l},y.minimaxWeights=function(n,t){void 0===t&&(t={constraints:{}}),void 0===t.constraints&&(t.constraints={});var r=!0;void 0!==t.constraints.fullInvestment&&(r=t.constraints.fullInvestment);var o=t.outputMinimumPortfolioReturn,i=n.length,e=n[0].length,a=it.fill(i+1,1,function(t,r){return t<=i?0:-1}),s=null,u=null;r&&(s=it.fill(1,i+1,function(t,r){return r<=i?1:0}),u=it.ones(1,1));var l=m(s,u,it.fill(e+(r?0:1),i+1,function(t,r){return t<=e?r<=i?-n[r-1][t-1]:1:t==e+1?r<=i?1:0:void 0}),it.fill(e+(r?0:1),1,function(t,r){return t<=e?0:t==e+1?1:void 0}),a,it.fill(i+1,1,function(t,r){return t<=i?0:-1/0}),it.fill(i+1,1,function(t,r){return t<=i?1:1/0}),{maxIter:-1})[0],h=l.toArray(function(t,r,n){return t!=i+1}),f=l.data[i];return!0===o?[h,f]:h},y.minimumCorrelationWeights=function(t,r){var n=(t=new it(t).toCovarianceMatrix()).getVariances(),o=n.elemMap(function(t,r,n){return 1/Math.sqrt(n)}),i=t.getCorrelationMatrix(),e=i.nbRows;if(e<=2)return y.inverseVolatilityWeights(n,r);for(var a=i.toArray(function(t,r,n){return t<r}),s=I(a),u=w(a),l=i.elemMap(function(t,r,n){return t==r?0:1-_((n-s)/u)}),h=l.toRowArray(function(t,r,n){return t!=r}),f=new Array(e),m=0;m<e;++m)f[m]=I(h[m]);var c=new it(d(f,0),1).normalize();return c=it.xy(l,c).normalize(),(c=it.vectorHadamardProduct(c,o).normalize()).toArray()},y.minimumTrackingErrorWeights=function(h,f,t){void 0===t&&(t={constraints:{}}),void 0===t.constraints&&(t.constraints={}),void 0===t.optimizationMethodParams&&(t.optimizationMethodParams={}),void 0===t.optimizationMethodParams.eps&&(t.optimizationMethodParams.eps=1e-4),void 0===t.optimizationMethodParams.maxIter&&(t.optimizationMethodParams.maxIter=1e4),void 0===t.constraints.minNbAssets&&t.constraints.maxNbAssets&&(t.constraints.minNbAssets=1),void 0===t.constraints.maxNbAssets&&t.constraints.minNbAssets&&(t.constraints.maxNbAssets=h.length);var r=t.optimizationMethodParams.eps,n=t.optimizationMethodParams.maxIter,z=!0;void 0!==t.constraints.fullInvestment&&(z=t.constraints.fullInvestment);var k=t.constraints.minNbAssets,I=t.constraints.maxNbAssets,o=k||I,i=t.optimizationMethodParams.nRounds;void 0===i&&(i=3);var e=t.optimizationMethodParams.nSteps;void 0===e&&(e=5e3);var a=t.optimizationMethodParams.nDeltas;void 0===a&&(a=e);var s=t.optimizationMethodParams.maxIterationsInitPoint;void 0===s&&(s=1e4);for(var S=h.length,u=h[0].length,l=(f=new it(f),h=it.fill(u,S,function(t,r){return h[r-1][t-1]}),"function"==typeof Float64Array?new Float64Array(S):new Array(S)),m="function"==typeof Float64Array?new Float64Array(S):new Array(S),c=0;c<S;++c)l[c]=t.constraints.minWeights?t.constraints.minWeights[c]:0,m[c]=t.constraints.maxWeights?t.constraints.maxWeights[c]:1;if(o){function d(t,r){var n;t=new it(t);if(r){var o=r.x_c,i=r.x_c_updatedIndexes;r.f_x_c;n=new it(r.f_x_c_context.assetsReturnsTx_m_b);for(var e=0;e<i.length;++e)for(var a=i[e],s=t.data[a]-o[a],u=0;u<h.nbRows;++u)n.data[u]+=h.data[u*h.nbColumns+a]*s}else n=it.xmy(it.xy(h,t),f);var l=n.vectorNorm("two");return{f_x:.5*l*l,f_x_context:{assetsReturnsTx_m_b:n}}}try{var w=1;z||(w=Math.random()),v=y.randomWeights(S,{maxIter:s,constraints:{minExposure:w,maxExposure:1,minNbAssets:k,maxNbAssets:I,minWeights:l,maxWeights:m}})}catch(t){throw"maximum number of iterations reached"===t.message?new Error("infeasible problem detected"):t}var F=new U(S,void 0,!0),p=new it(T(d,v,{nSteps:e,nRounds:i,nDeltas:a,neighbourGenerator:function(t,r){for(var n=r.lowerBounds,o=r.upperBounds,i=t,e=0,a=1,s=0;s<S;++s)if(0<i[s]&&0==n[s]||i[s]>=n[s]&&0<n[s]){if(++e,a-=i[s],i[s]<n[s])throw new Error("internal error: asset present in the portfolio, but strictly below its lower bound");if(i[s]>o[s])throw new Error("internal error: asset present in the portfolio, but strictly above its upper bound")}if(a=Math.max(0,a),I<e)throw new Error("internal error: number of assets strictly greater than the allowed maximum number of assets");if(e<k)throw new Error("internal error: number of assets strictly lower than the allowed minimum number of assets");for(var u=[],l=F.next(),h=0;h<S;++h){if(0<i[s=l[h]-1]&&0==n[s]||i[s]>=n[s]&&0<n[s]){var f=i[s]-n[s],m=Math.min(0,f),c=i[s];z||(u.push([s,-1,m,f]),k<e&&u.push([s,-1,c]));for(var d=0;d<S;++d){if((i[d]<n[d]||0==i[d])&&i[d]<o[d]){var w=n[d],p=Math.max(w,o[d]-i[d]);if(e<I&&m<=w&&w<=f){var v=w,b=Math.min(p,f);u.push([s,d,v,b])}w<=c&&c<=p&&u.push([s,d,c])}if((0<i[d]&&0==n[d]||i[d]>=n[d]&&0<n[d])&&i[d]<o[d]){p=o[d]-i[d],w=Math.min(0,p);if(k<e&&w<=c&&c<=p&&u.push([s,d,c]),m<=w&&w<=f){v=w,b=Math.min(p,f);u.push([s,d,v,b])}}}}var y=!1;if(0!=u.length&&(y=!0),!z){if((0<i[s]&&0==n[s]||i[s]>=n[s]&&0<n[s])&&i[s]<o[s]){p=o[s]-i[s];if((w=Math.min(0,p))<=a){v=w,b=Math.min(p,a);u.push([-1,s,v,b])}}if((i[s]<n[s]||0==i[s])&&i[s]<o[s]&&e<I){w=n[s],p=Math.max(w,o[s]-i[s]);if(w<=a){v=w,b=Math.min(p,a);u.push([-1,s,v,b])}}}if(y)break}if(0==u.length)throw new Error("internal error: no feasible switch");var g,x,C,R,E,A=u[(g=0,x=u.length,Math.floor(Math.random()*(x-g))+g)],M=[],P=A[0],_=A[1];if(3==A.length)C=A[2],-1!=P&&(i[P]=0,M.push(P)),-1!=_&&(i[_]+=C,M.push(_));else{if(4!=A.length)throw new Error("internal error: unexpected lenght of the switches structure");R=A[2],E=A[3],C=Math.random()*(E-R)+R,-1!=P&&(i[P]-=C,M.push(P)),-1!=_&&(i[_]+=C,M.push(_))}return{xx:i,x_updated_indexes:M.filter(function(t,r,n){return n.indexOf(t)==r})}},neighbourGeneratorParameters:{assetsRandomIterator:F,lowerBounds:l,upperBounds:m}})[0])}else{function d(t){var r=it.xmy(it.xy(h,t),f).vectorNorm("two");return.5*r*r}var v;p=B(d,function(t){return it.txy(h,it.xmy(it.xy(h,t),f))},function(t){return H(t.data,l,m)},function(t){return new it(Z(t.data,l,m))},v=new it(Z(it.ones(h.nbColumns,1).data,l,m)),{eps:r,maxIter:n,maxLine:n})[0]}return p.toArray()},y.mostDiversifiedWeights=function(t,r){void 0===r&&(r={}),void 0===r.constraints&&(r.constraints={}),void 0===r.optimizationMethodParams&&(r.optimizationMethodParams={});var n=r.epsVolatility;void 0===n&&(n=1e-4);var o=r.optimizationMethod;if(void 0===o&&(o="automatic"),"critical-line"!=o&&"gsmo"!=o&&"automatic"!=o)throw new Error("unsupported optimisation method");var i,e=new it(t).toCovarianceMatrix().getStandardDeviations();if("automatic"==o)i=new $(e,t,r);else if("critical-line"==o)i=new X(e,t,r);else{if("gsmo"!=o)throw new Error("internal error: unsupported optimisation method");i=new et(e,t,r)}i.restrict("minVolatility",n);return i.computeMaximumSharpeRatioEfficientPortfolio(0)[0].toArray()},y.numericalOptimizationWeights=function(t,r,n){void 0===n&&(n={}),void 0===n.constraints&&(n.constraints={}),void 0===n.optimizationMethodParams&&(n.optimizationMethodParams={});var o=n.optimizationMethod;if(void 0===o&&(o="grid-search"),"grid-search"===o&&void 0===n.optimizationMethodParams.k&&(n.optimizationMethodParams.k=t),"grid-search"===o)return u(r,t,n.optimizationMethodParams.k,n.constraints.minWeights,n.constraints.maxWeights);throw new Error("unsupported optimisation method")},y.postOptimizationWeights=function(t,r){void 0===r&&(r={roundingOptimizationMethodParams:{}}),void 0===r.roundingOptimizationMethodParams&&(r.roundingOptimizationMethodParams={});var m=r.portfolioValue,n=r.assetsPrices,o=r.sizeLots;if(null==m||0==m)throw new Error("missing portfolio value");if(null==n)throw new Error("missing assets prices");null==o&&(o=it.ones(t.length,1).data);var i=r.roundingOptimizationMethodParams.nRounds;void 0===i&&(i=3);var e=r.roundingOptimizationMethodParams.nSteps;void 0===e&&(e=5e3);var a=r.roundingOptimizationMethodParams.nDeltas;void 0===a&&(a=e);var d=t.length,s=K(t),c=it.fill(d+1,1,function(t,r){return t<=d?s[t-1]:0});c.data[d]=1-c.sum();var w=it.fill(d+1,1,function(t,r){return t<=d?o[t-1]*n[t-1]:1});function u(t,r){if(r)var n=r.x_c,o=r.x_c_updatedIndexes,i=r.f_x_c;var e=0,a=1/m;if(o){e=i;for(var s=0;s<o.length;++s){var u=o[s],l=c.data[u],h=t[u]*w.data[u]*a,f=n[u]*w.data[u]*a;e+=Math.pow(l-h,2)-Math.pow(l-f,2)}}else for(u=0;u<d+1;++u)l=c.data[u],h=t[u]*w.data[u]*a,e+=Math.pow(l-h,2);return{f_x:e,f_x_context:{}}}for(var l=1,h=0;h<d;++h)1e-12<c.data[h]&&++l;for(var f="function"==typeof UInt32Array?new UInt32Array(l):new Array(l),p=(h=0,0);h<d;++h)1e-12<c.data[h]&&(f[p]=h,++p);f[l-1]=d;var v=it.zeros(d+1,1).data;v[d]=m;for(p=0;p<l-1;++p){v[h=f[p]]=Math.floor(c.data[h]*m/w.data[h]),v[d]-=v[h]*w.data[h]}if(v[d]<0)throw new Error("internal error: negative cash during intitial feasible point generation");for(;;){var b=-1,y=u(v).f_x;for(p=0;p<l-1;++p){h=f[p];if(w.data[h]<=v[d]){v[h]+=1,v[d]-=w.data[h];var g=u(v).f_x;g<y&&(b=h,y=g),v[h]-=1,v[d]+=w.data[h]}}if(-1==b)break;v[b]+=1,v[d]-=w.data[b]}if(v[d]<0)throw new Error("internal error: negative cash during intitial feasible point generation");var x=T(u,v,{nSteps:e,nRounds:i,nDeltas:a,neighbourGenerator:function(t,r){function n(t,r){return Math.floor(Math.random()*(r-t))+t}for(var o,i=r.workingAssetsRandomIterator.next(),e=0;e<i.length&&(0==t[o=i[e]]&&o!=d);++e);var a=[];if(o!=d){var s=n(1,t[o]+1);t[o]-=s;var u=w.data[o]*s;t[d]+=u,a.push(o),a.push(d)}var l,h,f=r.workingAssetsRandomIterator.next();for(e=0;e<f.length&&(l=f[e])!=d&&0==(h=Math.floor(t[d]/w.data[l]));++e);if(l!=d){var m=n(1,h+1);t[l]+=m;var c=w.data[l]*m;t[d]-=c,a.push(l),a.push(d)}return{xx:t,x_updated_indexes:a.filter(function(t,r,n){return n.indexOf(t)==r})}},neighbourGeneratorParameters:{workingAssetsRandomIterator:new U(null,f.slice(),!0)}})[0],C=new it.fill(d,1,function(t,r){return x[t-1]*w.data[t-1]/m}).toArray();return[new it.fill(d,1,function(t,r){return x[t-1]}).toArray(),C,x[d]]},y.proportionalMinimumVarianceWeights=function(t,r){for(var n=(t=new it(t)).nbRows,o=t.toRowArray(),i=new Array(n),e=0;e<n;++e)i[e]=I(o[e]);var a=I(i),s=w(i),u=new it(i,1).elemMap(function(t,r,n){return 1-_((n-a)/s)});u=u.normalize(u);var l=t.diagonal().elemMap(function(t,r,n){return 1/n}).normalize();return(u=it.vectorHadamardProduct(u,l).normalize()).toArray()},y.randomSubspaceOptimizationWeights=function(t,r,n){void 0===n&&(n={}),void 0===n.constraints&&(n.constraints={}),void 0===n.subsetOptimizationFctOpt&&(n.subsetOptimizationFctOpt={}),void 0===n.subsetOptimizationFctOpt.constraints&&(n.subsetOptimizationFctOpt.constraints={});var o=n.constraints.minWeights;null==o&&(o=it.zeros(t,1).data);var i=n.constraints.maxWeights;if(null==i&&(i=it.ones(t,1).data),t<=1)return[1];var e=n.sizeSubsets;if(void 0===e&&(e=Math.max(2,Math.floor(Math.sqrt(t)))),e<=1||t+1<=e)throw new Error("the size of the subsets of assets must be between 2 and "+t.toString());var a=n.subsetsGenerationMethod;void 0===a&&(a="random");var s,u=n.nbRandomSubsets;if(void 0===u&&(u=128),e===t&&(u=1),"random"===a)s=u;else{if("deterministic"!==a)throw new Error("unsupported subsets of assets generation method");s=C(t,e)}var l=n.subsetsAggregationMethod;if(void 0===l&&(l="average"),"average"!==l&&"median"!==l)throw new Error("unsupported aggregation method");var h,f=n.maxInfeasibleSubsetsRatio;if(void 0===f&&(f=0),"random"===a)h=new x(t,e,!1);else{if("deterministic"!==a)throw new Error("unsupported subsets generation method");h=new R(t,e,!1)}for(var m=n.subsetOptimizationFctOpt,c=0,d=new Array(s),w=0;w<s;++w){var p=h.next();m.constraints.minWeights="function"==typeof Float64Array?new Float64Array(e):new Array(e);for(var v=0;v<e;++v)m.constraints.minWeights[v]=o[p[v]-1];m.constraints.maxWeights="function"==typeof Float64Array?new Float64Array(e):new Array(e);for(v=0;v<e;++v)m.constraints.maxWeights[v]=i[p[v]-1];try{var b=r(p,m);if(b.length!=e)throw new Error("internal error: the portfolio optimization method did not return the expected number of weights")}catch(t){if("infeasible portfolio optimization problem"===t.message)continue;throw t}var y=it.zeros(t,1);for(v=0;v<e;++v)y.setValueAt(p[v],1,b[v]);d[c++]=y}if(0===(d.length=c))throw new Error("no feasible portfolio generated");var g=s-c;if(1<=g&&f<=g/s)throw new Error("too many infeasible portfolios generated");y=null;if("average"==l)y=E(d);else{if("median"!=l)throw new Error("internal error");y=A(d)}return y.toArray()},y.randomSubspaceMeanVarianceOptimizationWeights=function(a,s,t){void 0===t&&(t={}),void 0===t.constraints&&(t.constraints={}),void 0===t.subsetsOpt&&(t.subsetsOpt={}),void 0===t.subsetsOpt.constraints&&(t.subsetsOpt.constraints={});var u=t.constraints.minExposure;null==u&&(u=1);var l=t.constraints.maxExposure;null==l&&(l=1);a=new it(a);var r=(s=new it(s)).nbColumns;if(void 0===t.sizeSubsets){var n=-2*Math.sqrt(r*(r+3)/2),o=2.25-1*n,i=n/-(1.5+Math.sqrt(o));t.sizeSubsets=Math.max(2,Math.floor(i))}return t.subsetOptimizationFctOpt=t.subsetsOpt,y.randomSubspaceOptimizationWeights(r,function(t,n){var o=t.length,i=a.submatrix(t,[1]),e=s.submatrix(t,t);1!=u&&(i=it.fill(o+1,1,function(t,r){return t<=o?i.getValue(t,1):0}),e=it.fill(o+1,o+1,function(t,r){return t<=o&&r<=o?e.getValue(t,r):0}),n.constraints.minWeights=it.fill(o+1,1,function(t,r){return t<=o?n.constraints.minWeights[t-1]:1-l}).data,n.constraints.maxWeights=it.fill(o+1,1,function(t,r){return t<=o?n.constraints.maxWeights[t-1]:1-u}).data);try{var r=y.meanVarianceOptimizationWeights(i,e,n);return 1!=u&&(r=r.slice(0,o)),r}catch(t){throw t.message.includes("no matching efficient portfolio")||"infeasible problem detected: the restricted simplex is empty"===t.message?new Error("infeasible portfolio optimization problem"):t}},t)},y.randomSubspaceGlobalMinimumVarianceOptimizationWeights=function(a,t){void 0===t&&(t={}),void 0===t.constraints&&(t.constraints={}),void 0===t.subsetsOpt&&(t.subsetsOpt={}),void 0===t.subsetsOpt.optimizationMethodParams&&(t.subsetsOpt.optimizationMethodParams={}),void 0===t.subsetsOpt.constraints&&(t.subsetsOpt.constraints={});var s=t.constraints.minExposure;null==s&&(s=1);var u=t.constraints.maxExposure;null==u&&(u=1);var r=(a=new it(a)).nbColumns;if(void 0===t.sizeSubsets){var n=null==h?1:3,o=null==h?-2*Math.sqrt(r*(r+1)/2):-2*Math.sqrt(r*(r+3)/2),i=n/2,e=i*i-1*o,l=o/-(i+Math.sqrt(e));t.sizeSubsets=Math.max(2,Math.floor(l))}var h=t.mu;return h=null==h?it.zeros(r,1):new it(h),t.subsetOptimizationFctOpt=t.subsetsOpt,y.randomSubspaceOptimizationWeights(r,function(t,n){var o=t.length,i=a.submatrix(t,t),e=h.submatrix(t,[1]);n.mu=e,1!=s&&(e=it.fill(o+1,1,function(t,r){return t<=o?e.getValue(t,1):0}),n.mu=e,i=it.fill(o+1,o+1,function(t,r){return t<=o&&r<=o?i.getValue(t,r):0}),n.constraints.minWeights=it.fill(o+1,1,function(t,r){return t<=o?n.constraints.minWeights[t-1]:1-u}).data,n.constraints.maxWeights=it.fill(o+1,1,function(t,r){return t<=o?n.constraints.maxWeights[t-1]:1-s}).data);try{var r=y.globalMinimumVarianceWeights(i,n);return 1!=s&&(r=r.slice(0,o)),r}catch(t){throw"infeasible problem detected: the restricted simplex is empty"===t.message?new Error("infeasible portfolio optimization problem"):t}},t)},y.randomSubspaceMaximumSharpeRatioWeights=function(a,s,u,t){void 0===t&&(t={}),void 0===t.constraints&&(t.constraints={}),void 0===t.subsetsOpt&&(t.subsetsOpt={}),void 0===t.subsetsOpt.optimizationMethodParams&&(t.subsetsOpt.optimizationMethodParams={}),void 0===t.subsetsOpt.constraints&&(t.subsetsOpt.constraints={});var l=t.constraints.minExposure;null==l&&(l=1);var h=t.constraints.maxExposure;null==h&&(h=1);a=new it(a);var r=(s=new it(s)).nbColumns;if(void 0===t.sizeSubsets){var n=-2*Math.sqrt(r*(r+3)/2),o=2.25-1*n,i=n/-(1.5+Math.sqrt(o));t.sizeSubsets=Math.max(2,Math.floor(i))}return t.subsetOptimizationFctOpt=t.subsetsOpt,y.randomSubspaceOptimizationWeights(r,function(t,n){var o=t.length,i=a.submatrix(t,[1]),e=s.submatrix(t,t);1!=l&&(i=it.fill(o+1,1,function(t,r){return t<=o?i.getValue(t,1):0}),e=it.fill(o+1,o+1,function(t,r){return t<=o&&r<=o?e.getValue(t,r):0}),n.constraints.minWeights=it.fill(o+1,1,function(t,r){return t<=o?n.constraints.minWeights[t-1]:1-h}).data,n.constraints.maxWeights=it.fill(o+1,1,function(t,r){return t<=o?n.constraints.maxWeights[t-1]:1-l}).data);try{var r=y.maximumSharpeRatioWeights(i,e,u,n);return 1!=l&&(r=r.slice(0,o)),r}catch(t){throw"infeasible problem detected: the restricted simplex is empty"===t.message||"impossible to restrict the efficient frontier: the minimum return constraint is not feasible"===t.message||"impossible to restrict the efficient frontier: the minimum volatility constraint is not feasible"===t.message?new Error("infeasible portfolio optimization problem"):t}},t)},y.randomWeights=function(t,r){void 0===r&&(r={}),void 0===r.constraints&&(r.constraints={});var n=r.constraints.minNbAssets||r.constraints.maxNbAssets,o=r.constraints.minNbAssets;void 0===o&&(o=1);var i=r.constraints.maxNbAssets;void 0===i&&(i=t);var e=r.constraints.minExposure;void 0===e&&(e=1);var a=r.constraints.maxExposure;void 0===a&&(a=1);var s=r.maxIter;void 0===s&&(s=1e4);for(var u=-1;;){if(++u,-1!==s&&s<u)throw new Error("maximum number of iterations reached");var l=Math.floor(Math.random()*(i-o+1))+o,h=new x(t,l,!1).next(),f=Math.random()*(a-e)+e,m=0;if(1!==f){m=1;for(var c="function"==typeof Float64Array?new Float64Array(l+m):new Array(l+m),d="function"==typeof Float64Array?new Float64Array(l+m):new Array(l+m),w=0;w<l;++w)c[w]=0,d[w]=1;var p=1-f;c[l]=p,d[l]=p}if(r.constraints.minWeights){if(1===f)c="function"==typeof Float64Array?new Float64Array(l):new Array(l);for(w=0;w<l;++w)c[w]=r.constraints.minWeights[h[w]-1]}if(r.constraints.maxWeights){if(1===f)d="function"==typeof Float64Array?new Float64Array(l):new Array(l);for(w=0;w<l;++w)d[w]=r.constraints.maxWeights[h[w]-1]}try{Y(l+m,c,d)}catch(t){continue}var v=new Q(l+m,c,d).sample();try{if(n)for(w=0;w<l;++w)if(0==v[w])throw new Error("generated weights not compatible with cardinality constraints")}catch(t){continue}break}var b=it.zeros(t,1);for(w=0;w<l;++w){var y=h[w],g=v[w];b.setValueAt(y,1,g)}return b.toArray()},y.riskBudgetingWeights=function(_,z,k){function I(t,r){var n=it.vectorDotProduct(r,t);if(Math.abs(n)<=o)n=0;else if(n<0&&n<-o)throw new Error("negative volatility, covariance matrix might not be semi-definite positive");return Math.sqrt(n)}function r(t,r,n){for(var o=it.fill(T,1,function(t,r){return 1/T}),i=o.elemMap(function(t,r,n){return Math.log(n)}),e=(it.copy(o),it.xy(_,o)),a=I(o,e),s=it.vectorDotProduct(z,i),u=.5*a-s,l=new S(T),h=0;-1==O||h!=O;){if(-1==O&&-1!=V&&V<=h)throw new Error("maximum number of cycles reached: "+V);var f;for(++h,l.generateCoordinates();;){var m=l.sampleCoordinate();if(-1==m)break;"acf"===k.coordinatesSampler&&(f=.5*a-s);var c=o.data[m-1],d=i.data[m-1],w=_.data[(m-1)*_.nbColumns+(m-1)],p=e.data[m-1]-o.data[m-1]*w,v=-t*z.data[m-1]*a,b=p/2,y=0<=b?1:-1,g=b*b-w*v;if(g<0)throw new Error("internal error: negative discriminant detected, the covariance matrix might not be semi-definite positive");var x,C=-(b+y*Math.sqrt(g)),R=C/w,E=v/C;if(0<R)x=R;else{if(!(0<E))throw new Error("internal error: no strictly positive root detected, the covariance matrix might not be semi-definite positive");x=E}r&&x<r[m-1]&&(x=r[m-1]),n&&x>n[m-1]&&(x=n[m-1]),o.data[m-1]=x,i.data[m-1]=Math.log(x),s-=d*z.data[m-1],s+=i.data[m-1]*z.data[m-1];for(var A=1;A<=T;++A)e.data[A-1]+=_.data[(A-1)*_.nbColumns+(m-1)]*x,e.data[A-1]-=_.data[(A-1)*_.nbColumns+(m-1)]*c;if(a=I(o,e),"acf"===k.coordinatesSampler){var M=f-(.5*a-s);1==h?l.updateAverageGain(M):l.updateSchedulingPreference(m,M)}}var P=.5*a-s;if(-1==O&&Math.abs(P-u)<=F)break;u=P}return o}void 0===k&&(k={}),void 0===k.constraints&&(k.constraints={}),void 0===k.eps&&(k.eps=1e-10),void 0===k.epsSdp&&(k.epsSdp=1e-12),void 0===k.maxCycles&&(k.maxCycles=1e4),void 0===k.nbCycles&&(k.nbCycles=-1),void 0===k.outputPortfolioVolatility&&(k.outputPortfolioVolatility=!1),void 0===k.coordinatesSampler&&(k.coordinatesSampler="cyclic");var S,F=k.eps,o=k.epsSdp,V=k.maxCycles,O=k.nbCycles,t=k.outputPortfolioVolatility;if("cyclic"===k.coordinatesSampler)S=function(t){this.n=t,this.k=t,this.sampleCoordinate=function(){return this.k==this.n?-1:++this.k},this.generateCoordinates=function(){this.k=0}};else if("shuffledCyclic"===k.coordinatesSampler)S=function(t){this.n=t,this.k=t,this.r="function"==typeof Uint32Array?new Uint32Array(t):new Array(t);for(var r=0;r<t;++r)this.r[r]=r+1;this.sampleCoordinate=function(){return this.k==this.n?-1:this.r[this.k++]},this.generateCoordinates=function(){this.r=new U(void 0,this.r,!0).next(),this.k=0}};else if("randomized"===k.coordinatesSampler)S=function(t){this.n=t,this.k=t;for(var r="function"==typeof Float64Array?new Float64Array(t):new Array(t),n=0;n<t;++n)r[n]=1/t;this.s=new N(r),this.sampleCoordinate=function(){return this.k==this.n?-1:(++this.k,this.s.sample()+1)},this.generateCoordinates=function(){this.k=0}};else{if("acf"!==k.coordinatesSampler)throw new Error("unsupported coordinates sampler");S=function(t){this.n=t,this.k=0,this.change_rate=.2,this.p_min=.05,this.p_max=20,this.idx_set_tmp="function"==typeof Uint32Array?new Uint32Array(2*t):new Array(2*t),this.idx_set=null,this.idx_set_len=0,this.pref="function"==typeof Float64Array?new Float64Array(t):new Array(t);for(var r=0;r<t;++r)this.pref[r]=1;for(this.prefsum=t,this.acc="function"==typeof Float64Array?new Float64Array(t):new Array(t),r=0;r<t;++r)this.acc[r]=.5;this.gain_learning_rate=1/t,this.average_gain=0,this.sampleCoordinate=function(){return this.k==this.idx_set_len?-1:this.idx_set[this.k++]},this.generateCoordinates=function(){this.k=0,this.idx_set_len=0;for(var t=this.n/this.prefsum,r=0;r<this.n;++r){for(var n=this.acc[r]+t*this.pref[r],o=Math.floor(n),i=0;i<o;++i)this.idx_set_tmp[this.idx_set_len]=r+1,this.idx_set_len++;this.acc[r]=n-o}this.idx_set=new U(void 0,this.idx_set_tmp.slice(0,this.idx_set_len),!0).next()},this.updateSchedulingPreference=function(t,r){var n=this.pref[t-1]*Math.exp(this.change_rate*(r/this.average_gain-1));n<this.p_min?n=this.p_min:n>this.p_max&&(n=this.p_max),this.prefsum=this.prefsum+n-this.pref[t-1],this.pref[t-1]=n,this.average_gain=(1-this.gain_learning_rate)*this.average_gain+this.gain_learning_rate*r},this.updateAverageGain=function(t){this.average_gain+=t/this.n}}}var T=(_=new it(_)).nbRows,n=(z=new it(z),null),i=null;if(k.constraints.minWeights&&(n=k.constraints.minWeights,!k.constraints.maxWeights)){i="function"==typeof Float64Array?new Float64Array(T):new Array(T);for(var e=0;e<i.length;++e)i[e]=1}if(k.constraints.maxWeights&&(i=k.constraints.maxWeights,!k.constraints.minWeights)){n="function"==typeof Float64Array?new Float64Array(T):new Array(T);for(e=0;e<n.length;++e)n[e]=0}var a,s=r(1);if(s=s.normalize(),n||i){Y(T,n,i);for(var u=I(s,it.xy(_,s)),l=.5*u,h=r(l,n,i),f=0,m=54,c=!1;0<h.sum()-1;){if(m<++f)throw new Error("internal error: maximum number of iterations reached when searching for a bracketing interval, the problem might be infeasible");if(Math.abs(h.sum()-1)<=F){c=!0;break}h=r(l*=.5,n,i)}for(var d=2*u,w=r(d,n,i),p=(f=0,m=54,!1);w.sum()-1<0;){if(m<++f)throw new Error("internal error: maximum number of iterations reached when searching for a bracketing interval, the problem might be infeasible");if(Math.abs(w.sum()-1)<=F){p=!0;break}w=r(d*=2,n,i)}if(c)a=h;else if(p)a=w;else{a=r(q(function(t){return r(t,n,i).sum()-1},l,d),n,i)}}else a=s;return!0===t?[a.toArray(),I(a,it.xy(_,a))]:a.toArray()},y}(PortfolioAllocation||{}),"undefined"!=typeof module&&(module.exports=PortfolioAllocation);